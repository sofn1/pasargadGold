{% extends "admin_dashboard/dashboard.html" %}

{% block title %}مدیریت وبلاگ‌ها{% endblock %}

{% block mainContent %}
<div class="container-fluid px-4">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <h2 class="text-white mb-0">وبلاگ‌ها</h2>
    <a href="{% url 'admin_dashboard:admin_blogs_create' %}" class="btn btn-success">
      <i class="fas fa-plus"></i> افزودن جدید
    </a>
  </div>

  <!-- Filters / Search -->
  <div class="card shadow-sm border-0 mb-3 rounded-4">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end" id="searchForm">
        <div class="col-12 col-md-3">
          <label class="form-label mb-1">جستجو بر اساس</label>
          <select class="form-select" name="field" id="fieldSelect">
            {% with fs=request.GET.field %}
            <option value="name"             {% if fs == "name" or not fs %}selected{% endif %}>عنوان</option>
            <option value="english_name"     {% if fs == "english_name" %}selected{% endif %}>نام انگلیسی (Slug/SEO)</option>
            <option value="writer_name"      {% if fs == "writer_name" %}selected{% endif %}>نام نویسنده</option>
            <option value="tag"              {% if fs == "tag" %}selected{% endif %}>برچسب</option>
            <option value="category"         {% if fs == "category" %}selected{% endif %}>شناسه دسته‌بندی محصول</option>
            <option value="read_time"        {% if fs == "read_time" %}selected{% endif %}>زمان مطالعه (دقیقه)</option>
            <option value="publish_date"     {% if fs == "publish_date" %}selected{% endif %}>تاریخ انتشار (بازه)</option>
            {% endwith %}
          </select>
        </div>

        <!-- Generic text/number value -->
        <div class="col-12 col-md-4" id="valueWrap">
          <label class="form-label mb-1">عبارت جستجو</label>
          <input type="text" class="form-control" name="value" value="{{ request.GET.value }}" placeholder="بنویسید…">
        </div>

        <!-- Date range (visible only when field=publish_date) -->
        <div class="col-12 col-md-3 d-none" id="dateFromWrap">
          <label class="form-label mb-1">از تاریخ</label>
          <input type="date" class="form-control" name="date_from" value="{{ request.GET.date_from }}">
        </div>
        <div class="col-12 col-md-3 d-none" id="dateToWrap">
          <label class="form-label mb-1">تا تاریخ</label>
          <input type="date" class="form-control" name="date_to" value="{{ request.GET.date_to }}">
        </div>

        <div class="col-12 col-md-2 ms-auto">
          <button class="btn btn-primary w-100"><i class="fas fa-search"></i> جستجو</button>
        </div>

        <!-- Quick clear -->
        {% if request.GET %}
        <div class="col-12 col-md-2">
          <a class="btn btn-outline-secondary w-100" href="{% url 'admin_dashboard:admin_blogs' %}">پاک کردن فیلترها</a>
        </div>
        {% endif %}
      </form>
    </div>
  </div>

  {% if blogs %}
  <!-- Table -->
  <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th style="width:76px">تصویر</th>
            <th>عنوان / اسلاگ</th>
            <th>نویسنده</th>
            <th>برچسب‌ها</th>
            <th>دسته‌بندی‌ها</th>
            <th class="text-nowrap">انتشار</th>
            <th class="text-nowrap">مطالعه</th>
            <th class="text-end">عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for blog in blogs %}
          <tr id="row-{{ blog.id }}">
            <td>
              {% if blog.view_image %}
                <img src="{{ blog.view_image.url }}" alt="{{ blog.name }}" style="height:56px;width:56px;object-fit:cover;border-radius:.5rem;border:1px solid #2b3036;">
              {% else %}
                <div class="d-flex justify-content-center align-items-center rounded" style="height:56px;width:56px;background:#0f1216;border:1px solid #2b3036;">
                  <i class="far fa-image text-secondary"></i>
                </div>
              {% endif %}
            </td>

            <td>
              <div class="fw-semibold">{{ blog.name|default:"—" }}</div>
              <div class="text-secondary small">{{ blog.english_name|default:"-" }}</div>
              {% if blog.short_description %}
              <div class="small mt-1 text-muted">{{ blog.short_description|truncatechars:80 }}</div>
              {% endif %}
            </td>

            <td class="text-nowrap">
              <div class="fw-semibold">{{ blog.writer_name|default:"-" }}</div>
              {% if blog.writer_profile %}
                <a href="{{ blog.writer_profile }}" class="small text-info" target="_blank" rel="noopener">پروفایل</a>
              {% endif %}
            </td>

            <td style="max-width:240px;">
              {% with blog.tags.all as tg %}
                {% if tg %}
                  {% for t in tg %}
                    <span class="badge rounded-pill me-1 mb-1"
                          style="background: {% if t.color %}{{ t.color }}{% else %}#2a2f38{% endif %}; color:#fff;">
                      {{ t.name }}
                    </span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              {% endwith %}
            </td>

            <td style="max-width:240px;">
              {% if blog.category_names_list %}
                {% for cname in blog.category_names_list %}
                  <span class="badge bg-secondary-subtle text-secondary-emphasis border me-1 mb-1">{{ cname }}</span>
                {% endfor %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>


            <td class="text-nowrap">
              <div class="fw-semibold">{{ blog.publish_time|date:"Y/m/d" }}</div>
              <div class="small text-secondary">{{ blog.publish_time|date:"H:i" }}</div>
            </td>

            <td class="text-nowrap">
              <span class="badge bg-info">{{ blog.read_time|default:"-" }} دقیقه</span>
            </td>

            <td class="text-end">
              <div class="btn-group">
                <a href="{% url 'admin_dashboard:admin_blogs_edit' blog.pk %}" class="btn btn-sm btn-warning">ویرایش</a>
                <button type="button"
                        class="btn btn-sm btn-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        data-id="{{ blog.pk }}"
                        data-name="{{ blog.name|default:blog.english_name }}">
                  حذف
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% include 'admin_dashboard/_pagination.html' %}
  </div>

  {% else %}
    <div class="alert alert-info">وبلاگی یافت نشد.</div>
  {% endif %}

  <!-- Delete modal (shared) -->
  {% include 'admin_dashboard/_delete_modal.html'
     with object_type="وبلاگ"
     delete_url_name='admin_dashboard:admin_blog_delete'
     delete_dummy_pk=0
     return_url='admin_dashboard:admin_blogs' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Toggle inputs based on selected field
  const fieldSelect = document.getElementById('fieldSelect');
  const valueWrap   = document.getElementById('valueWrap');
  const dateFrom    = document.getElementById('dateFromWrap');
  const dateTo      = document.getElementById('dateToWrap');

  function refreshFieldUI(){
    const f = fieldSelect.value;
    const isDate = (f === 'publish_date');
    valueWrap.classList.toggle('d-none', isDate);
    dateFrom.classList.toggle('d-none', !isDate);
    dateTo.classList.toggle('d-none', !isDate);

    // tune input type for read_time (number)
    const valueInput = valueWrap.querySelector('input[name="value"]');
    if (valueInput){
      valueInput.type = (f === 'read_time') ? 'number' : 'text';
      valueInput.placeholder = (f === 'tag')
        ? 'نام برچسب…'
        : (f === 'category')
          ? 'شناسه دسته (ID)…'
          : (f === 'english_name')
            ? 'اسلاگ/نام انگلیسی…'
            : 'بنویسید…';
    }
  }
  if (fieldSelect){ fieldSelect.addEventListener('change', refreshFieldUI); refreshFieldUI(); }
})();
</script>
{% endblock %}
