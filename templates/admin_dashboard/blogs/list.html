{% extends "admin_dashboard/dashboard.html" %}

{% block title %}مدیریت وبلاگ‌ها{% endblock %}

{% block mainContent %}
<div class="container-fluid px-4 py-3">

  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
    <h2 class="text-white fw-bold mb-0" style="font-size: 1.75rem;">
      <i class="fas fa-blog me-2 text-primary"></i>وبلاگ‌ها
    </h2>
    <a href="{% url 'admin_dashboard:admin_blogs_create' %}" class="btn btn-lg btn-success shadow-sm d-flex align-items-center">
      <i class="fas fa-plus-circle me-2"></i> افزودن جدید
    </a>
  </div>

  <!-- Filters / Search -->
  <div class="card shadow-sm border-0 mb-4 rounded-4 bg-gradient" style="background: linear-gradient(135deg, #1a1c23, #232630);">
    <div class="card-body p-4">
      <form method="get" class="row g-3" id="searchForm">
        <div class="col-12 col-md-3">
          <label class="form-label text-light fw-semibold mb-2">جستجو بر اساس</label>
          <select class="form-select form-select-sm" name="field" id="fieldSelect" style="border-radius: .75rem;">
            {% with fs=request.GET.field %}
            <option value="name"             {% if fs == "name" or not fs %}selected{% endif %}>عنوان</option>
            <option value="english_name"     {% if fs == "english_name" %}selected{% endif %}>نام انگلیسی (Slug/SEO)</option>
            <option value="writer_name"      {% if fs == "writer_name" %}selected{% endif %}>نام نویسنده</option>
            <option value="tag"              {% if fs == "tag" %}selected{% endif %}>برچسب</option>
            <option value="category"         {% if fs == "category" %}selected{% endif %}>شناسه دسته‌بندی محصول</option>
            <option value="read_time"        {% if fs == "read_time" %}selected{% endif %}>زمان مطالعه (دقیقه)</option>
            <option value="publish_date"     {% if fs == "publish_date" %}selected{% endif %}>تاریخ انتشار (بازه)</option>
            {% endwith %}
          </select>
        </div>

        <!-- Generic text/number input -->
        <div class="col-12 col-md-4" id="valueWrap">
          <label class="form-label text-light fw-semibold mb-2">عبارت جستجو</label>
          <input type="text" class="form-control form-control-sm" name="value"
                 value="{{ request.GET.value }}" placeholder="بنویسید…" style="border-radius: .75rem;">
        </div>

        <!-- Date range inputs -->
        <div class="col-12 col-md-3 d-none" id="dateFromWrap">
          <label class="form-label text-light fw-semibold mb-2">از تاریخ</label>
          <input type="date" class="form-control form-control-sm" name="date_from"
                 value="{{ request.GET.date_from }}" style="border-radius: .75rem;">
        </div>
        <div class="col-12 col-md-3 d-none" id="dateToWrap">
          <label class="form-label text-light fw-semibold mb-2">تا تاریخ</label>
          <input type="date" class="form-control form-control-sm" name="date_to"
                 value="{{ request.GET.date_to }}" style="border-radius: .75rem;">
        </div>

        <!-- Search Button -->
        <div class="col-12 col-md-2 d-flex align-items-end">
          <button class="btn btn-primary btn-sm w-100 py-2 fw-medium d-flex justify-content-center align-items-center"
                  style="border-radius: .75rem; box-shadow: 0 4px 6px rgba(0, 123, 255, 0.2);">
            <i class="fas fa-search me-2"></i> جستجو
          </button>
        </div>

        <!-- Clear Filters -->
        {% if request.GET %}
        <div class="col-12 col-md-2 d-flex align-items-end">
          <a class="btn btn-outline-light btn-sm w-100 py-2"
             href="{% url 'admin_dashboard:admin_blogs' %}"
             style="border-radius: .75rem;">
            <i class="fas fa-times me-1"></i> پاک کردن
          </a>
        </div>
        {% endif %}
      </form>
    </div>
  </div>

  {% if blogs %}
  <!-- Table Card -->
  <div class="card shadow-sm border-0 rounded-4 overflow-hidden" style="background: #1a1c23;">
    <div class="table-responsive" style="min-height: 400px;">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead class="table-borderless" style="background: #232630;">
          <tr>
            <th style="width:76px;"></th>
            <th>عنوان / اسلاگ</th>
            <th>نویسنده</th>
            <th>برچسب‌ها</th>
            <th>دسته‌بندی‌ها</th>
            <th class="text-nowrap">انتشار</th>
            <th class="text-nowrap">زمان مطالعه</th>
            <th class="text-end">عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for blog in blogs %}
          <tr id="row-{{ blog.id }}" class="border-bottom border-secondary-subtle" style="transition: background 0.2s ease;">
            <!-- Image -->
            <td>
              {% if blog.view_image %}
                <img src="{{ blog.view_image.url }}" alt="{{ blog.name }}"
                     style="height:60px;width:60px;object-fit:cover;border-radius:.75rem;border:2px solid #3a3f4b;">
              {% else %}
                <div class="d-flex justify-content-center align-items-center rounded"
                     style="height:60px;width:60px;background:#15181f;border:2px solid #3a3f4b;">
                  <i class="far fa-image text-secondary fs-4"></i>
                </div>
              {% endif %}
            </td>

            <!-- Title & Slug -->
            <td>
              <div class="fw-bold text-white mb-1">{{ blog.name|default:"—" }}</div>
              <div class="text-muted small"><code>{{ blog.english_name|default:"-" }}</code></div>
              {% if blog.short_description %}
                <div class="small mt-1 text-muted border-start ps-2" style="opacity: 0.8;">
                  {{ blog.short_description|truncatechars:80 }}
                </div>
              {% endif %}
            </td>

            <!-- Writer -->
            <td class="text-nowrap">
              <div class="fw-semibold">{{ blog.writer_name|default:"—" }}</div>
              {% if blog.writer_profile %}
                <a href="{{ blog.writer_profile }}" target="_blank" rel="noopener"
                   class="small text-info d-flex align-items-center mt-1">
                  <i class="fas fa-external-link-alt me-1"></i> پروفایل
                </a>
              {% endif %}
            </td>

            <!-- Tags -->
            <td style="max-width:240px; line-height: 1.6;">
              {% with blog.tags.all as tg %}
                {% if tg %}
                  {% for t in tg %}
                    <span class="badge rounded-pill me-1 mb-1 px-3 py-2"
                          style="background: {{ t.color|default:'#2a2f38' }}; color: #fff; font-size: 0.75rem;">
                      {{ t.name }}
                    </span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted fst-italic">ندارد</span>
                {% endif %}
              {% endwith %}
            </td>

            <!-- Categories -->
            <td style="max-width:240px;">
              {% if blog.category_names_list %}
                {% for cname in blog.category_names_list %}
                  <span class="badge bg-opacity-10 bg-light text-light border border-light-subtle me-1 mb-1 px-3">
                    {{ cname }}
                  </span>
                {% endfor %}
              {% else %}
                <span class="text-muted fst-italic">ندارد</span>
              {% endif %}
            </td>

            <!-- Publish Time -->
            <td class="text-nowrap">
              <div class="fw-semibold text-white">{{ blog.publish_time|date:"Y/m/d" }}</div>
              <div class="small text-secondary">{{ blog.publish_time|date:"H:i" }}</div>
            </td>

            <!-- Read Time -->
            <td class="text-nowrap">
              <span class="badge bg-gradient text-white px-3 py-2"
                    style="background: linear-gradient(90deg, #17a2b8, #0dcaf0); font-size: 0.8rem;">
                {{ blog.read_time|default:"-" }} دقیقه
              </span>
            </td>

            <!-- Actions -->
            <td class="text-end">
              <div class="btn-group btn-group-sm shadow-sm" role="group">
                <a href="{% url 'admin_dashboard:admin_blogs_edit' blog.pk %}"
                   class="btn btn-outline-light d-flex align-items-center px-3"
                   style="border-radius: .5rem .0rem .0rem .5rem;">
                  <i class="fas fa-edit me-1"></i> ویرایش
                </a>
                <button type="button"
                        class="btn btn-danger d-flex align-items-center px-3"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        data-id="{{ blog.pk }}"
                        data-name="{{ blog.name|default:blog.english_name }}"
                        style="border-radius: 0 .5rem .5rem 0;">
                  <i class="fas fa-trash-alt me-1"></i> حذف
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% include 'admin_dashboard/_pagination.html' %}
  </div>

  {% else %}
    <div class="text-center py-5">
      <i class="far fa-newspaper text-secondary" style="font-size: 4rem; opacity: 0.4;"></i>
      <h5 class="text-muted mt-3">وبلاگی یافت نشد</h5>
      <p class="text-secondary">هیچ مقاله‌ای با فیلترهای اعمال شده یافت نشد.</p>
      <a href="{% url 'admin_dashboard:admin_blogs' %}" class="btn btn-outline-secondary btn-sm mt-2">
        <i class="fas fa-sync-alt me-1"></i> نمایش همه
      </a>
    </div>
  {% endif %}

  <!-- Delete Modal -->
  {% include 'admin_dashboard/_delete_modal.html' with object_type="وبلاگ" delete_url_name='admin_dashboard:admin_blog_delete' delete_dummy_pk=0 return_url='admin_dashboard:admin_blogs' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const fieldSelect = document.getElementById('fieldSelect');
  const valueWrap   = document.getElementById('valueWrap');
  const dateFrom    = document.getElementById('dateFromWrap');
  const dateTo      = document.getElementById('dateToWrap');

  function refreshFieldUI(){
    const f = fieldSelect.value;
    const isDate = (f === 'publish_date');

    valueWrap.classList.toggle('d-none', isDate);
    dateFrom.classList.toggle('d-none', !isDate);
    dateTo.classList.toggle('d-none', !isDate);

    const valueInput = valueWrap.querySelector('input[name="value"]');
    if (valueInput){
      valueInput.type = (f === 'read_time') ? 'number' : 'text';
      valueInput.placeholder = (f === 'tag')
        ? 'نام برچسب…'
        : (f === 'category')
          ? 'شناسه دسته (ID)…'
          : (f === 'english_name')
            ? 'اسلاگ/نام انگلیسی…'
            : 'بنویسید…';
    }
  }

  if (fieldSelect){
    fieldSelect.addEventListener('change', refreshFieldUI);
    refreshFieldUI();
  }
})();
</script>
{% endblock %}

{% block extra_css %}
<style>
  .btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  .table tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.03) !important;
  }
  .form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    border-color: #0d6efd;
  }
  .badge {
    font-weight: 500;
  }
  code {
    background: #2a2f38;
    color: #6ee7b7;
    padding: 0.2em 0.4em;
    border-radius: 0.375rem;
    font-size: 0.85em;
  }
</style>
{% endblock %}