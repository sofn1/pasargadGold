{% extends "admin_dashboard/dashboard.html" %}
{% load static %}

{% block title %}{{ title|default:"ایجاد بلاگ" }}{% endblock %}

{% block mainContent %}
<div class="container-fluid px-2 px-md-3 py-3">

  <!-- Sticky top bar (actions + device switches) -->
  <div class="position-sticky top-0 z-3 mb-3" style="backdrop-filter:saturate(180%) blur(8px);">
    <div class="card border-0 shadow-sm rounded-3" style="background:rgba(20,22,26,.8);">
      <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary rounded-pill px-3 py-2 fs-6">
              {% if is_edit %}ویرایش بلاگ{% else %}ایجاد بلاگ جدید{% endif %}
            </span>
            <small class="text-secondary d-none d-md-inline">سازنده بصری (سبک Elementor)</small>
          </div>

          <div class="d-flex align-items-center gap-2 ms-auto">
            <div class="btn-group me-1" role="group" aria-label="Devices">
              <button id="btn-desktop" type="button" class="btn btn-outline-light btn-sm">دسکتاپ</button>
              <button id="btn-tablet"  type="button" class="btn btn-outline-light btn-sm">تبلت</button>
              <button id="btn-mobile"  type="button" class="btn btn-outline-light btn-sm">موبایل</button>
            </div>

            <button class="btn btn-outline-info btn-sm d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#builderSidebar" aria-controls="builderSidebar">
              پنل ابزار
            </button>

            <button id="btn-clear"   type="button" class="btn btn-outline-danger btn-sm">پاک‌سازی</button>
            <button id="btn-preview" type="button" class="btn btn-outline-secondary btn-sm">پیش‌نمایش</button>
            <button id="btn-save"    type="submit" class="btn btn-primary btn-sm px-3">ذخیره بلاگ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" id="blog-form" class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="card-body p-3 p-md-4">
      {% csrf_token %}
      {% if form.errors %}
        <div class="alert alert-danger">لطفاً خطاها را بررسی کنید.</div>
      {% endif %}

      <!-- === Form sections === -->
      <div class="row g-3 mb-4">
        <!-- مشخصات اصلی -->
        <div class="col-12">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-body-tertiary border-0 fw-semibold">مشخصات اصلی</div>
            <div class="card-body row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">عنوان</label>
                {{ form.name }}
                <small class="text-secondary">عنوان نمایشی بلاگ</small>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">نام انگلیسی</label>
                {{ form.english_name }}
                <small class="text-secondary">برای URL یا SEO</small>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ تگ‌ها و دسته‌بندی‌ها -->
        <div class="col-12">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-body-tertiary border-0 fw-semibold">تگ‌ها و دسته‌بندی‌ها</div>
            <div class="card-body row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">دسته‌بندی محصول</label>
                {{ form.product_category }}
                <small class="text-secondary">دسته‌بندی مرتبط با محصول را انتخاب کنید.</small>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">برچسب‌ها</label>
                {{ form.tags }}
                <small class="text-muted d-block mt-1">می‌توانید چند برچسب را انتخاب کنید.</small>
              </div>
            </div>
          </div>
        </div>

        <!-- زمان و رسانه -->
        <div class="col-12">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-body-tertiary border-0 fw-semibold">زمان و رسانه</div>
            <div class="card-body row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label">زمان انتشار</label>
                {{ form.publish_time }}
                <small class="text-muted d-block">قالب پیشنهادی: YYYY/MM/DD، HH:MM</small>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">زمان مطالعه (دقیقه)</label>
                {{ form.read_time }}
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label">تصویر نمایشی</label>
                {{ form.view_image }}
              </div>
            </div>
          </div>
        </div>

        <!-- توضیح کوتاه -->
        <div class="col-12">
          <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-body-tertiary border-0 fw-semibold">توضیح کوتاه</div>
            <div class="card-body">
              {{ form.short_description }}
              <small class="text-muted d-block mt-1">می‌توانید خالی بگذارید تا از اولین پاراگراف پر شود.</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Hidden fields for builder output -->
      {{ form.content }}           <!-- stores HTML -->
      <input type="hidden" name="project_json" value="">

      <!-- Builder layout -->
      <div class="row g-3">
        <div class="col-12 col-lg-9 order-2 order-lg-1">
          <div id="gjs" class="border rounded-4 shadow-sm" style="background:#14161a; min-height:70vh;"></div>
          <div class="d-flex flex-wrap align-items-center gap-2 mt-2 text-secondary small">
            <span class="badge bg-dark-subtle text-secondary-emphasis">میانبرها:</span>
            <span>Ctrl/Cmd + S = ذخیره</span>
            <span>•</span>
            <span>Ctrl/Cmd + Z = بازگشت</span>
            <span>•</span>
            <span>Ctrl/Cmd + Y/Shift+Z = جلو</span>
          </div>
        </div>

        <!-- Sidebar (Blocks / Traits) -->
        <div class="col-12 col-lg-3 order-1 order-lg-2">
          <div class="d-none d-lg-block">
            <div class="card border-0 shadow-sm rounded-4 mb-3">
              <div class="card-header bg-body-tertiary border-0 fw-semibold">بلوک‌ها</div>
              <div id="blocks" class="card-body p-2" style="max-height:35vh; overflow:auto;"></div>
            </div>
            <div class="card border-0 shadow-sm rounded-4">
              <div class="card-header bg-body-tertiary border-0 fw-semibold">خصوصیات المان</div>
              <div id="traits" class="card-body p-2" style="max-height:35vh; overflow:auto;"></div>
            </div>
          </div>

          <!-- Offcanvas for mobile -->
          <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="builderSidebar" aria-labelledby="builderSidebarLabel" style="width: 86vw; max-width: 420px;">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="builderSidebarLabel">ابزار سازنده</h5>
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="pills-blocks-tab" data-bs-toggle="pill" data-bs-target="#pills-blocks" type="button" role="tab">بلوک‌ها</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="pills-traits-tab" data-bs-toggle="pill" data-bs-target="#pills-traits" type="button" role="tab">خصوصیات</button>
                </li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane fade show active" id="pills-blocks" role="tabpanel">
                  <div id="blocks-mobile" style="max-height:60vh; overflow:auto;"></div>
                </div>
                <div class="tab-pane fade" id="pills-traits" role="tabpanel">
                  <div id="traits-mobile" style="max-height:60vh; overflow:auto;"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- /Offcanvas -->
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="previewModalLabel">پیش‌نمایش بلاگ</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <iframe id="previewFrame" class="w-100 border-0 rounded-3 shadow" style="height: calc(100vh - 140px); background:#0e0f11;"></iframe>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
<script src="https://unpkg.com/grapesjs"></script>

<style>
  body { direction: rtl; }
  .card { background: #171a1f; color: #e9ecef; }
  .card-header { background: #1b1f26; color: #cfd3da; }
  .form-control, .form-select, textarea { background: #0f1216; color: #e9ecef; border-color: #2a2f38; }
  .form-control:focus, .form-select:focus, textarea:focus { background:#10141a; color:#fff; border-color:#3d4a7a; box-shadow:none; }
  .btn-outline-light { border-color:#3a3f48; }
  .btn-outline-light:hover { background:#2a2f38; }
  .btn-primary { background:#1C39BB; border: none; }
  .btn-outline-danger { border-color:#7a2a2a; }
  .badge.bg-primary { background:#1C39BB !important; }
  .gjs-one-bg{ background:#101216 !important; } .gjs-two-bg{ background:#171a1f !important; } .gjs-three-bg{ background:#1b1f26 !important; }
  .gjs-four-color{ color:#cfd3da !important; } .gjs-color-warn{ color:#ffb454 !important; } .gjs-title{ color:#dfe3ea !important; }
  .card-body input[type="text"], .card-body input[type="url"], .card-body input[type="number"], .card-body input[type="file"], .card-body input[type="datetime-local"], .card-body select, .card-body textarea {
    width: 100%; background: #0f1216; color: #e9ecef; border: 1px solid #2a2f38; border-radius: 10px; padding: .55rem .75rem;
  }
  .card-body input:focus, .card-body select:focus, .card-body textarea:focus { outline: none; border-color: #3d4a7a; background:#10141a; }
  .card-header { border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
  #blocks .gjs-block, #blocks-mobile .gjs-block { border-radius: 12px; padding: 10px; margin: 6px; border:1px dashed #2a2f38; background:#111318; cursor:grab; text-align:center; }
  #blocks .gjs-block:hover, #blocks-mobile .gjs-block:hover { background:#171a1f; }
  #gjs .gjs-cv-canvas { border-radius: 12px; overflow: hidden; }
</style>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
  {% if is_edit %}const IS_EDIT = true;{% else %}const IS_EDIT = false;{% endif %}

  const editor = grapesjs.init({
    container: '#gjs',
    fromElement: false,
    height: '70vh',
    storageManager: { type: null },
    selectorManager: { componentFirst: true },
    deviceManager: { devices: [{ name:'Desktop', width:'' }, { name:'Tablet', width:'768px' }, { name:'Mobile', width:'360px' }] },
    assetManager: { upload: "{% url 'admin_dashboard:admin_grapes_asset_upload' %}", uploadName: 'files', headers: { 'X-CSRFToken': csrf }, multiUpload: true },
    blockManager: { appendTo: '#blocks' },
    traitManager: { appendTo: '#traits' },
  });

  const bm = editor.BlockManager;
  bm.add('section',{ label:'سکشن', category:{id:'layout',label:'چیدمان',open:true}, content:`<section class="container py-4"><div class="row g-3"><div class="col-12"></div></div></section>` });
  bm.add('cols-2',{ label:'۲ ستونه', category:{id:'layout',label:'چیدمان',open:true}, content:`<section class="container py-4"><div class="row g-4"><div class="col-12 col-md-6"></div><div class="col-12 col-md-6"></div></div></section>` });
  bm.add('heading',{ label:'عنوان', category:{id:'content',label:'محتوا',open:true}, content:`<h2 class="mb-2">عنوان بلاگ</h2>` });
  bm.add('paragraph',{ label:'پاراگراف', category:{id:'content',label:'محتوا',open:true}, content:`<p>متن پاراگراف شما اینجاست...</p>` });
  bm.add('image',{ label:'تصویر', category:{id:'media',label:'رسانه',open:true}, content:{type:'image'} });
  bm.add('quote',{ label:'نقل‌قول', category:{id:'content',label:'محتوا',open:true}, content:`<blockquote class="p-3 my-2" style="border-right:4px solid #1C39BB;background:#101216;">نقل‌قول مهم...</blockquote>` });
  bm.add('button',{ label:'دکمه', category:{id:'content',label:'محتوا',open:true}, content:`<a class="btn btn-primary" href="#">بیشتر بخوانید</a>` });
  bm.add('video',{ label:'ویدیو', category:{id:'media',label:'رسانه',open:true}, content:`<div class="ratio ratio-16x9"><iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" allowfullscreen></iframe></div>` });
  bm.add('code',{ label:'کد', category:{id:'content',label:'محتوا',open:true}, content:`<pre class="p-3 rounded-3" style="background:#0f1216;border:1px solid #2a2f38;"><code>// کد نمونه</code></pre>` });
  bm.add('product-card',{ label:'کارت محصول', category:{id:'catalog',label:'کاتالوگ',open:true}, content:`<div class="card p-3" data-product-id=""><h5>نام محصول</h5><img src="" alt="" class="img-fluid mb-2"/><p class="mb-2">توضیح کوتاه...</p><a class="btn btn-outline-primary">نمایش محصول</a></div>` });

  const domc = editor.DomComponents;
  domc.addType('product-card', {
    model: {
      defaults: { traits: [{ type:'text', name:'data-product-id', label:'شناسه محصول' }, { type:'text', name:'data-button-label', label:'متن دکمه' }] },
      isComponent: (el) => el?.classList?.contains('card') && el.getAttribute('data-product-id') !== null ? { type:'product-card' } : false
    }
  });

  function moveChildren(fromEl, toEl){ if(!fromEl||!toEl) return; while(fromEl.firstChild) toEl.appendChild(fromEl.firstChild); }
  const offcanvasEl  = document.getElementById('builderSidebar');
  const blocksWrap   = document.getElementById('blocks');
  const blocksMobile = document.getElementById('blocks-mobile');
  const traitsWrap   = document.getElementById('traits');
  const traitsMobile = document.getElementById('traits-mobile');

  if (offcanvasEl) {
    offcanvasEl.addEventListener('show.bs.offcanvas', () => {
      const blocksContent = blocksWrap?.querySelector('.gjs-blocks-c') || blocksWrap?.firstElementChild;
      if (blocksContent && blocksMobile) blocksMobile.appendChild(blocksContent);
      moveChildren(traitsWrap, traitsMobile);
    });
    offcanvasEl.addEventListener('hidden.bs.offcanvas', () => {
      const blocksContent = blocksMobile?.querySelector('.gjs-blocks-c') || blocksMobile?.firstElementChild;
      if (blocksContent && blocksWrap) blocksWrap.appendChild(blocksContent);
      moveChildren(traitsMobile, traitsWrap);
    });
  }

  document.getElementById('btn-desktop')?.addEventListener('click', () => editor.setDevice('Desktop'));
  document.getElementById('btn-tablet') ?.addEventListener('click', () => editor.setDevice('Tablet'));
  document.getElementById('btn-mobile') ?.addEventListener('click', () => editor.setDevice('Mobile'));

  document.getElementById('btn-clear')?.addEventListener('click', () => { if (confirm('همه محتوا پاک شود؟')) editor.DomComponents.clear(); });

  const previewBtn   = document.getElementById('btn-preview');
  const previewModal = document.getElementById('previewModal') ? new bootstrap.Modal(document.getElementById('previewModal')) : null;
  const previewFrame = document.getElementById('previewFrame');

  previewBtn?.addEventListener('click', () => {
    const html = editor.getHtml();
    const css  = `<style>${editor.getCss()}</style>`;
    const doc  = `<html dir="rtl"><head><meta charset="utf-8">${css}</head><body style="background:#0e0f11;color:#e9ecef;">${html}</body></html>`;
    const blob = new Blob([doc], {type:'text/html'});
    const url  = URL.createObjectURL(blob);
    if (previewFrame) { previewFrame.src = url; previewModal?.show(); }
  });

  const formEl = document.getElementById('blog-form');

  function fillBuilderIntoForm(){
    const html = editor.getHtml() + `<style>${editor.getCss()}</style>`;
    const contentEl = document.querySelector('[name="content"]');
    if (contentEl) contentEl.value = html;

    const pj = editor.getProjectData?.();
    const pjEl = document.querySelector('[name="project_json"]');
    if (pjEl && pj) pjEl.value = JSON.stringify(pj);

    const sd = document.querySelector('[name="short_description"]');
    if (sd && !sd.value) {
      const tmp = document.createElement('div'); tmp.innerHTML = editor.getHtml();
      const p = tmp.querySelector('p'); if (p) sd.value = p.textContent.trim().slice(0, 200);
    }
    try { localStorage.removeItem('blog_builder_draft'); } catch(e){}
  }

  formEl?.addEventListener('submit', (e) => {
    e.preventDefault();
    fillBuilderIntoForm();
    editor.clearDirtyCount();
    setTimeout(() => { formEl.submit(); }, 100);
  });

  document.getElementById('btn-save')?.addEventListener('click', (ev) => {
    ev.preventDefault();
    if (formEl?.requestSubmit) formEl.requestSubmit();
    else { fillBuilderIntoForm(); formEl?.submit(); }
  });

  document.addEventListener('keydown', function(e){
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
      e.preventDefault();
      if (formEl?.requestSubmit) formEl.requestSubmit();
      else { fillBuilderIntoForm(); formEl?.submit(); }
    }
  });

  let dirty = false;
  editor.on('change', () => { dirty = true; });
  window.addEventListener('beforeunload', function (e) { if (dirty) { e.preventDefault(); e.returnValue = ''; } });

  const DRAFT_KEY = 'blog_builder_draft';
  setInterval(() => {
    try { const payload = { html: editor.getHtml(), css: editor.getCss(), time: Date.now() }; localStorage.setItem(DRAFT_KEY, JSON.stringify(payload)); } catch(e){}
  }, 30000);

  try {
    const draftRaw = localStorage.getItem(DRAFT_KEY);
    if (draftRaw && !IS_EDIT) {
      const draft = JSON.parse(draftRaw);
      if (draft?.html) {
        if (confirm('پیش‌نویس ذخیره‌شده‌ای یافت شد. بازیابی شود؟')) {
          editor.setComponents(draft.html);
          editor.setStyle(draft.css || '');
        }
      }
    }
  } catch(e){}

  {% if is_edit and blog and blog.content %}
    editor.setComponents(`{{ blog.content|escapejs }}`);
  {% endif %}
})();
</script>
{% endblock %}
