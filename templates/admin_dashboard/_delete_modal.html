<!-- Reusable Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">تایید حذف</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        آیا از حذف "<strong id="del-name"></strong>" مطمئن هستید؟
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
        <form method="post" id="delete-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">حذف</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('deleteModal');
    const nameEl = document.getElementById('del-name');
    const form = document.getElementById('delete-form');

    // A reversed URL with a dummy pk we can replace safely:
    // e.g. "/admin-dashboard/brands/0/delete/"
    const urlTemplate = "{% url 'admin_dashboard:admin_brand_delete' 0 %}";

    // Robustly replace the "/0/" path segment with "/<id>/"
    function buildDeleteUrl(id) {
      return urlTemplate.replace(/\/\d+\//, `/${id}/`);
    }

    modal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const id = button.getAttribute('data-id');
      const name = button.getAttribute('data-name') || '';

      nameEl.textContent = name;
      form.action = buildDeleteUrl(id);

      // Reset any previous handler to avoid stacking
      form.onsubmit = function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        })
        .then(res => {
          if (!res.ok) throw new Error('Network error');
          return res.json();
        })
        .then(data => {
          if (data.success) {
            // Close modal
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();

            // Remove the row if present, otherwise reload
            const row = button.closest('tr');
            if (row) {
              row.remove();
            } else {
              window.location.reload();
            }
          } else {
            alert('خطا: ' + (data.error || 'عملیات ناموفق بود.'));
          }
        })
        .catch(err => {
          console.error(err);
          alert('خطایی رخ داد. لطفاً دوباره تلاش کنید.');
        });
      };
    });
  });
</script>
