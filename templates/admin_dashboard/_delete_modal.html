<!-- Reusable Delete Modal (GLOBAL) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">تایید حذف {{ object_type|default:"آیتم" }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        آیا از حذف "<strong id="del-name"></strong>" مطمئن هستید؟
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌</button>
        <form method="post" id="delete-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">🗑️</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function () {
    var modal = document.getElementById('deleteModal');
    if (!modal) return;

    var nameEl = document.getElementById('del-name');
    var form   = document.getElementById('delete-form');

    // Build a URL template with an explicit placeholder that's easy to replace.
    // The delete view must accept exactly one pk/uuid parameter.
    // Example usage from including template:
    //   delete_url_name='admin_dashboard:category_delete'
    // We reverse with a placeholder "__ID__" then replace it at runtime.
    var urlTemplate = "{% url delete_url_name '__ID__' %}";

    // Fallback if someone forgets to pass delete_url_name
    if (!urlTemplate || urlTemplate.indexOf('__ID__') === -1) {
      console.warn('Delete modal: delete_url_name not provided or URL cannot be reversed.');
    }

    function buildDeleteUrl(id) {
      // Replace the placeholder with raw id (supports UUIDs and ints)
      return urlTemplate.replace('__ID__', id);
    }

    modal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget; // the trigger button
      if (!button) return;

      var id   = button.getAttribute('data-id');
      var name = button.getAttribute('data-name') || '';

      if (nameEl) nameEl.textContent = name || '';
      if (form && id) {
        form.action = buildDeleteUrl(id);
      }

      // Ensure only one submit handler is active
      form.onsubmit = function (e) {
        e.preventDefault();

        // If you want non-AJAX behavior globally, comment this fetch block
        // and just call: form.submit();
        var formData = new FormData(form);

        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            // CSRF from hidden input rendered by {% csrf_token %}
            'X-CSRFToken': (form.querySelector('[name=csrfmiddlewaretoken]') || {}).value
          }
        })
        .then(function(res) {
          // If your delete views return JsonResponse on AJAX:
          //   return Json with {success: true}
          // Otherwise fall back to full reload on non-JSON.
          var contentType = res.headers.get('content-type') || '';
          if (contentType.indexOf('application/json') > -1) {
            return res.json().then(function(data){ return { ok: res.ok, data: data }; });
          }
          return { ok: res.ok, data: null };
        })
        .then(function(result) {
          if (!result.ok) throw new Error('Delete failed');

          if (result.data && result.data.success) {
            // Close modal
            var bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();

            // Remove the row if present; fallback reload
            var row = (event.relatedTarget && event.relatedTarget.closest('tr')) || null;
            if (row) {
              row.remove();
            } else {
              window.location.reload();
            }
          } else {
            // If server didn’t return JSON success, reload to reflect changes or show messages
            window.location.reload();
          }
        })
        .catch(function(err) {
          console.error(err);
          alert('خطایی رخ داد. لطفاً دوباره تلاش کنید.');
        });
      };
    });
  });
})();
</script>
