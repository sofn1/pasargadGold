<!-- Reusable Delete Modal (GLOBAL, UUID/int safe) -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">تایید حذف {{ object_type|default:"آیتم" }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        آیا از حذف "<strong id="del-name"></strong>" مطمئن هستید؟
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">❌</button>
        <form method="post" id="delete-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">🗑️</button>
        </form>
      </div>
    </div>
  </div>
</div>

{# Build a reversed URL with a valid dummy PK #}
{% if delete_url_name %}
  {% if delete_dummy_pk or delete_dummy_pk == 0 %}
    {% url delete_url_name delete_dummy_pk as delete_dummy_url %}
    <script>
      var DELETE_DUMMY_PK = "{{ delete_dummy_pk }}";
      var DELETE_URL_TEMPLATE = "{{ delete_dummy_url }}";
    </script>
  {% else %}
    {% url delete_url_name '00000000-0000-0000-0000-000000000000' as delete_dummy_url %}
    <script>
      var DELETE_DUMMY_PK = "00000000-0000-0000-0000-000000000000";
      var DELETE_URL_TEMPLATE = "{{ delete_dummy_url }}";
    </script>
  {% endif %}
{% else %}
  <script>
    console.warn("Delete modal: 'delete_url_name' not provided.");
    var DELETE_DUMMY_PK = null;
    var DELETE_URL_TEMPLATE = null;
  </script>
{% endif %}

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function () {
    var modal = document.getElementById('deleteModal');
    if (!modal) return;

    var nameEl = document.getElementById('del-name');
    var form   = document.getElementById('delete-form');

    function buildDeleteUrl(id) {
      return (DELETE_URL_TEMPLATE || '').replace(String(DELETE_DUMMY_PK), String(id));
    }

    modal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget; // the trigger button
      if (!button) return;

      var id   = button.getAttribute('data-id');
      var name = button.getAttribute('data-name') || '';

      if (nameEl) nameEl.textContent = name;
      if (form && id && DELETE_URL_TEMPLATE) form.action = buildDeleteUrl(id);

      form.onsubmit = function (e) {
        e.preventDefault();
        var formData = new FormData(form);
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': (form.querySelector('[name=csrfmiddlewaretoken]') || {}).value
          }
        })
        .then(function(res) {
          var ct = res.headers.get('content-type') || '';
          if (ct.indexOf('application/json') > -1) {
            return res.json().then(function(data){ return { ok: res.ok, data: data }; });
          }
          return { ok: res.ok, data: null };
        })
        .then(function(result) {
          if (!result.ok) throw new Error('Delete failed');
          // If view returns JSON {success: true}, remove row; else reload.
          if (result.data && result.data.success) {
            var bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) bsModal.hide();
            var row = (event.relatedTarget && event.relatedTarget.closest('tr')) || null;
            if (row) { row.remove(); } else { window.location.reload(); }
          } else {
            window.location.reload();
          }
        })
        .catch(function(err) {
          console.error(err);
          alert('خطایی رخ داد. لطفاً دوباره تلاش کنید.');
        });
      };
    });
  });
})();
</script>
