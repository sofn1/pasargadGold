{% extends "admin_dashboard/dashboard.html" %}

{% block title %}{{ title|default:"ایجاد محصول" }}{% endblock %}

{% block mainContent %}
<div class="container-fluid px-4">

  <!-- Header -->
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center my-4">
    <h2 class="text-white mb-0">
      {% if form.instance.pk %}ویرایش محصول{% else %}ایجاد محصول{% endif %}
    </h2>
    <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-secondary">بازگشت</a>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
    </div>
  {% endif %}

  {% if form.errors %}
    <script>window.__form_has_errors__ = true;</script>
    <div class="alert alert-danger">
      <strong>بررسی خطاها:</strong>
      <ul class="mb-0">
        {% for bf in form %}
          {% if bf.errors %}
            <li><b>{{ bf.label }}</b>:
              {% for e in bf.errors %}{{ e }}{% if not forloop.last %} | {% endif %}{% endfor %}
            </li>
          {% endif %}
        {% endfor %}
        {% for hf in form.hidden_fields %}
          {% if hf.errors %}
            <li><b>{{ hf.name }}</b>:
              {% for e in hf.errors %}{{ e }}{% if not forloop.last %} | {% endif %}{% endfor %}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <script>window.__form_has_errors__ = false;</script>
  {% endif %}

  <form id="product-form" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="row g-4">

      <!-- ===== مشخصات اصلی ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-box-open"></i><span>مشخصات اصلی</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.name %}
              <div class="col-md-6">
                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                {{ form.name }}
                {% for e in form.name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.english_name %}
              <div class="col-md-6">
                <label for="{{ form.english_name.id_for_label }}" class="form-label">{{ form.english_name.label }}</label>
                {{ form.english_name }}
                {% for e in form.english_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {# دسته‌بندی — multi-select like محصولات مرتبط, NO buttons, with chips #}
              {% if form.category_id %}
              <div class="col-12">
                <label for="{{ form.category_id.id_for_label }}" class="form-label">{{ form.category_id.label }}</label>
                <div class="flex-grow-1">{{ form.category_id }}</div>
                <small class="text-muted d-block mt-1">برای یافتن دسته تایپ کنید و انتخاب کنید. می‌توانید چند مورد را انتخاب کنید.</small>

                <!-- selected category chips -->
                <div id="category-chips" class="d-flex flex-wrap gap-2 mt-2"></div>

                {% for e in form.category_id.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.brand %}
              <div class="col-md-6">
                <label for="{{ form.brand.id_for_label }}" class="form-label">{{ form.brand.label }}</label>
                {{ form.brand }}
                {% for e in form.brand.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.price %}
              <div class="col-md-6">
                <label for="{{ form.price.id_for_label }}" class="form-label">{{ form.price.label }}</label>
                {{ form.price }}
                <small class="text-muted d-block mt-1">نمایش با ویرگول؛ مقدار خالص ذخیره می‌شود.</small>
                {% for e in form.price.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              <div class="col-md-3 d-flex align-items-end">
                {% if form.featured %}
                <div class="form-check">
                  {{ form.featured }}
                  <label class="form-check-label ms-1" for="{{ form.featured.id_for_label }}">{{ form.featured.label }}</label>
                </div>
                {% endif %}
              </div>

              <div class="col-md-3 d-flex align-items-end">
                {% if form.is_active %}
                <div class="form-check">
                  {{ form.is_active }}
                  <label class="form-check-label ms-1" for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
                </div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ===== مالک و توضیحات ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-user"></i><span>مالک و توضیحات</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.owner_name %}
              <div class="col-md-6">
                <label for="{{ form.owner_name.id_for_label }}" class="form-label">{{ form.owner_name.label }}</label>
                {{ form.owner_name }}
                {% for e in form.owner_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.owner_profile %}
              <div class="col-md-6">
                <label for="{{ form.owner_profile.id_for_label }}" class="form-label">{{ form.owner_profile.label }}</label>
                {{ form.owner_profile }}
                {% for e in form.owner_profile.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.short_description %}
              <div class="col-12">
                <label for="{{ form.short_description.id_for_label }}" class="form-label">{{ form.short_description.label }}</label>
                {{ form.short_description }}
                {% for e in form.short_description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.description %}
              <div class="col-12">
                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% for e in form.description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      <!-- ===== ویژگی‌ها (JSON) ===== -->
      {% if form.features %}
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-list-ul"></i><span>{{ form.features.label|default:"ویژگی‌ها (JSON)" }}</span>
          </div>
          <div class="card-body">
            <div id="features-repeater" class="border rounded p-3"
                 data-initial='{{ form.initial.features|default:form.instance.features|default:"{}"|escapejs }}'>
              <div id="feature-rows" class="d-flex flex-column gap-2"></div>
              <button type="button" id="add-feature" class="btn btn-sm btn-outline-primary mt-2">
                افزودن ویژگی
              </button>
            </div>
            <textarea id="features-hidden" name="{{ form.features.html_name }}" hidden></textarea>
            {% if form.features.errors %}
              <div class="text-danger small mt-2">
                {% for e in form.features.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ===== تصاویر ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-images"></i><span>تصاویر</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {# تصویر اصلی #}
              {% if form.view_image %}
              <div class="col-md-6">
                <label for="{{ form.view_image.id_for_label }}" class="form-label">{{ form.view_image.label }}</label>
                {% if form.instance.pk and form.instance.view_image %}
                  <div class="mb-2">
                    <img src="{{ form.instance.view_image.url }}" alt="preview"
                         style="max-height:96px;border-radius:.5rem;object-fit:cover;border:1px solid #eee;">
                  </div>
                {% endif %}
                {{ form.view_image }}
                <div id="main-image-preview" class="mt-2"></div>
                {% for e in form.view_image.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {# گالری تصاویر #}
              <div class="col-md-6">
                <label class="form-label d-block">
                  {% if form.images %}{{ form.images.label|default:"تصاویر اضافی" }}{% else %}تصاویر اضافی{% endif %}
                </label>

                <div id="images-field-wrap">
                  <input type="file"
                         id="id_extra_images"
                         name="extra_images"
                         accept="image/*"
                         class="form-control"
                         multiple>
                </div>

                <div class="d-flex align-items-center gap-2 mt-2">
                  <small class="text-muted">می‌توانید چند تصویر را با هم انتخاب کنید.</small>
                </div>

                <div id="existing-images-preview" class="d-flex flex-wrap gap-2 mt-3">
                  {% if form.instance.pk %}
                    {% for url in form.instance.images %}
                      <div class="thumb-wrap position-relative" data-url="{{ url }}">
                        <img src="{{ url }}" class="thumb" alt="img">
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 p-1 m-1" style="border-radius: 50%; width: 20px; height: 20px; font-size: 10px; line-height: 1;">&times;</button>
                      </div>
                    {% endfor %}
                  {% endif %}
                </div>

                <div id="extra-images-preview" class="d-flex flex-wrap gap-2 mt-3"></div>

                {% if form.images %}
                  <textarea id="images-hidden"
                            name="{{ form.images.html_name }}"
                            hidden>{{ form.instance.images|default:"[]"|safe }}</textarea>
                  {% if form.images.errors %}
                    <div class="text-danger small mt-2">
                      {% for e in form.images.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                    </div>
                  {% endif %}
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ===== ارتباطات ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-link"></i><span>ارتباطات</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.rel_blogs %}
              <div class="col-12">
                <label for="{{ form.rel_blogs.id_for_label }}" class="form-label">{{ form.rel_blogs.label }}</label>
                <div class="flex-grow-1">{{ form.rel_blogs }}</div>
                {% for e in form.rel_blogs.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.rel_news %}
              <div class="col-12">
                <label for="{{ form.rel_news.id_for_label }}" class="form-label">{{ form.rel_news.label }}</label>
                <div class="flex-grow-1">{{ form.rel_news }}</div>
                {% for e in form.rel_news.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.rel_products %}
              <div class="col-12">
                <label for="{{ form.rel_products.id_for_label }}" class="form-label">{{ form.rel_products.label }}</label>
                <div class="flex-grow-1">{{ form.rel_products }}</div>
                {% for e in form.rel_products.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      <!-- ===== سایر فیلدها (fallback امن) ===== -->
      {% with excluded="name|english_name|category_id|brand|price|featured|is_active|owner_name|owner_profile|short_description|description|features|view_image|images|rel_blogs|rel_news|rel_products" %}
        {% for field in form.visible_fields %}
          {% with token="|"|add:field.name|add:"|" all="|"|add:excluded|add:"|" %}
            {% if token not in all %}
              <div class="col-md-6">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% for e in field.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endwith %}
        {% endfor %}
      {% endwith %}

      {% for field in form.hidden_fields %}{{ field }}{% endfor %}

      <!-- ===== Actions ===== -->
      <div class="col-12">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success px-4">
            {% if form.instance.pk %}ذخیره{% else %}ایجاد{% endif %}
          </button>
          <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-outline-secondary">انصراف</a>
        </div>
      </div>

    </div>
  </form>
</div>
{% endblock %}


{% block extra_js %}
<script>
    // Utility function to initialize a Select2 field
    function initAjaxSelect2(selector, url, isMultiple, initialData) {
        const $el = $(selector);
        $el.select2({
            placeholder: "Search...",
            allowClear: true,
            multiple: isMultiple,
            ajax: {
                url: url,
                dataType: "json",
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.results
                    };
                }
            }
        });

        // Set the initial data for the select field
        if (initialData && initialData.length > 0) {
            initialData.forEach(item => {
                const newOption = new Option(item.text, item.id, true, true);
                $el.append(newOption);
            });
            $el.trigger('change');
        }
    }

    // Function to initialize the features repeater
    function initializeFeaturesRepeater(initialData) {
        const repeaterEl = document.getElementById('features-repeater');
        if (!repeaterEl) {
            console.error("Features repeater element not found!");
            return;
        }

        // Clear existing repeater items
        repeaterEl.innerHTML = '';

        // Add items from initial data
        if (Array.isArray(initialData)) {
            initialData.forEach(item => {
                // You will need to write the function `addFeatureItem` yourself
                // to add a new row to the repeater with the provided data.
                addFeatureItem(item.name, item.value);
            });
        }
    }


    $(document).ready(function() {
        const productId = "{{ form.instance.pk }}"; // Get the product ID from the Django form instance

        if (productId) {
            fetch(`/admin-dashboard/api/get-product/${productId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('API Error:', data.error);
                        return;
                    }

                    // Populate Select2 fields using the fetched data
                    initAjaxSelect2('#{{ form.category_id.id_for_label }}', "{% url 'admin_dashboard:api_search_categories' %}", true, data.category_id);
                    initAjaxSelect2('#{{ form.rel_blogs.id_for_label }}', "{% url 'admin_dashboard:api_search_blogs' %}", true, data.rel_blogs);
                    initAjaxSelect2('#{{ form.rel_news.id_for_label }}', "{% url 'admin_dashboard:api_search_news' %}", true, data.rel_news);
                    initAjaxSelect2('#{{ form.rel_products.id_for_label }}', "{% url 'admin_dashboard:api_search_products' %}", true, data.rel_products);

                    // Initialize the features repeater with fetched data
                    initializeFeaturesRepeater(data.features);

                    // If you have other fields, you can populate them here as well
                    if (data.name) {
                       document.getElementById("{{ form.name.id_for_label }}").value = data.name;
                    }

                })
                .catch(error => console.error('Error fetching product data:', error));
        } else {
            // For new product creation (no existing product ID)
            initAjaxSelect2('#{{ form.category_id.id_for_label }}', "{% url 'admin_dashboard:api_search_categories' %}", true, []);
            initAjaxSelect2('#{{ form.rel_blogs.id_for_label }}', "{% url 'admin_dashboard:api_search_blogs' %}", true, []);
            initAjaxSelect2('#{{ form.rel_news.id_for_label }}', "{% url 'admin_dashboard:api_search_news' %}", true, []);
            initAjaxSelect2('#{{ form.rel_products.id_for_label }}', "{% url 'admin_dashboard:api_search_products' %}", true, []);
        }
    });

</script>


{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">

<!-- Select2 (RTL) -->
<style>
  .select2-container .select2-selection--single { height: 38px; }
  .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 36px; }
  .select2-container--default .select2-selection--single .select2-selection__arrow { height: 36px; }
  .is-invalid { border-color:#dc3545 !important; }
  .thumb { height:72px;width:72px;object-fit:cover;border-radius:.5rem;border:1px solid #e9ecef; }
  .chip {
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.25rem .5rem; border-radius:999px; border:1px solid #dee2e6;
    background:#f8f9fa; font-size:.875rem;
  }
  .chip button { border:0; background:transparent; line-height:1; cursor:pointer; }
</style>


{% endblock %}
