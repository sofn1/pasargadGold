{% extends "admin_dashboard/dashboard.html" %}

{% block title %}{{ title|default:"ایجاد محصول" }}{% endblock %}

{% block mainContent %}
<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center my-4">
    <h2 class="text-white mb-0">
      {% if form.instance.pk %}ویرایش محصول{% else %}ایجاد محصول{% endif %}
    </h2>
    <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-secondary">بازگشت</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
        </div>
      {% endif %}

      <form id="product-form" method="post" enctype="multipart/form-data" class="row g-4">
        {% csrf_token %}

        <!-- نام / نام انگلیسی -->
        {% if form.name %}
          <div class="col-md-6">
            <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
            {{ form.name }}
            {% for e in form.name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}
        {% if form.english_name %}
          <div class="col-md-6">
            <label for="{{ form.english_name.id_for_label }}" class="form-label">{{ form.english_name.label }}</label>
            {{ form.english_name }}
            {% for e in form.english_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- دسته‌بندی (AJAX searchable) -->
        {% if form.category_id %}
          <div class="col-md-6">
            <label for="{{ form.category_id.id_for_label }}" class="form-label">{{ form.category_id.label }}</label>
            {{ form.category_id }}
            <small class="text-muted d-block mt-1">برای یافتن دسته تایپ کنید…</small>
            {% for e in form.category_id.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- برند -->
        {% if form.brand %}
          <div class="col-md-6">
            <label for="{{ form.brand.id_for_label }}" class="form-label">{{ form.brand.label }}</label>
            {{ form.brand }}
            {% for e in form.brand.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- قیمت (تومان) — بدون اسکریپت: کاما از سمت سرور -->
        {% if form.price %}
          <div class="col-md-6">
            <label for="{{ form.price.id_for_label }}" class="form-label">{{ form.price.label }}</label>
            {{ form.price }}
            {% for e in form.price.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- ویژه / فعال -->
        {% if form.featured %}
          <div class="col-md-3 d-flex align-items-end">
            <div class="form-check">
              {{ form.featured }}
              <label class="form-check-label ms-1" for="{{ form.featured.id_for_label }}">{{ form.featured.label }}</label>
            </div>
          </div>
        {% endif %}
        {% if form.is_active %}
          <div class="col-md-3 d-flex align-items-end">
            <div class="form-check">
              {{ form.is_active }}
              <label class="form-check-label ms-1" for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
            </div>
          </div>
        {% endif %}

        <!-- مالک / پروفایل -->
        {% if form.owner_name %}
          <div class="col-md-6">
            <label for="{{ form.owner_name.id_for_label }}" class="form-label">{{ form.owner_name.label }}</label>
            {{ form.owner_name }}
            {% for e in form.owner_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}
        {% if form.owner_profile %}
          <div class="col-md-6">
            <label for="{{ form.owner_profile.id_for_label }}" class="form-label">{{ form.owner_profile.label }}</label>
            {{ form.owner_profile }}
            {% for e in form.owner_profile.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- توضیحات -->
        {% if form.short_description %}
          <div class="col-12">
            <label for="{{ form.short_description.id_for_label }}" class="form-label">{{ form.short_description.label }}</label>
            {{ form.short_description }}
            {% for e in form.short_description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}
        {% if form.description %}
          <div class="col-12">
            <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
            {{ form.description }}
            {% for e in form.description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- ویژگی‌ها: تکرارشونده (JSON) -->
        {% if form.features %}
          <div class="col-12">
            <label class="form-label">{{ form.features.label }}</label>
            <div id="features-repeater" class="border rounded p-3"
                 data-initial='{{ form.initial.features|default:"{}"|escapejs }}'>
              <div id="feature-rows" class="d-flex flex-column gap-2"></div>
              <button type="button" id="add-feature" class="btn btn-sm btn-outline-primary mt-2">افزودن ویژگی</button>
            </div>
            <textarea id="features-hidden" name="{{ form.features.html_name }}" hidden></textarea>
            {% if form.features.errors %}
              <div class="text-danger small mt-2">
                {% for e in form.features.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        {% endif %}

        <!-- تصویر اصلی با پیش‌نمایش -->
        {% if form.view_image %}
          <div class="col-md-6">
            <label for="{{ form.view_image.id_for_label }}" class="form-label">{{ form.view_image.label }}</label>
            {% if form.instance.pk and form.instance.view_image %}
              <div class="mb-2">
                <img src="{{ form.instance.view_image.url }}" alt="preview"
                     style="max-height:96px;border-radius:.5rem;object-fit:cover;border:1px solid #eee;">
              </div>
            {% endif %}
            {{ form.view_image }}
            <div id="main-image-preview" class="mt-2"></div>
            {% for e in form.view_image.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- تصاویر اضافی با پیش‌نمایش -->
        <div class="col-md-6">
          <label class="form-label">تصاویر</label>
          <input type="file" id="extra-images" name="extra_images" class="form-control" accept="image/*" multiple>
          <small class="text-muted d-block mt-1">می‌توانید چند تصویر انتخاب کنید؛ پیش‌نمایش در زیر نمایش داده می‌شود.</small>
          <div id="extra-images-preview" class="d-flex flex-wrap gap-2 mt-2"></div>

          {% if form.instance.pk and form.instance.images %}
            <div class="mt-3">
              <div class="text-muted mb-1">تصاویر موجود:</div>
              <div class="d-flex flex-wrap gap-2">
                {% for img in form.instance.images %}
                  <img src="{{ img }}" alt="image"
                       style="height:72px;width:72px;object-fit:cover;border-radius:.5rem;border:1px solid #e9ecef;">
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>

        <!-- مرتبط‌ها: AJAX searchable -->
        {% if form.rel_blogs %}
          <div class="col-12">
            <label for="{{ form.rel_blogs.id_for_label }}" class="form-label">{{ form.rel_blogs.label }}</label>
            <div class="d-flex gap-2">
              <div class="flex-grow-1">{{ form.rel_blogs }}</div>
              <button type="button" class="btn btn-outline-primary" data-open-select="#{{ form.rel_blogs.id_for_label }}">افزودن</button>
            </div>
            {% for e in form.rel_blogs.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        {% if form.rel_news %}
          <div class="col-12">
            <label for="{{ form.rel_news.id_for_label }}" class="form-label">{{ form.rel_news.label }}</label>
            <div class="d-flex gap-2">
              <div class="flex-grow-1">{{ form.rel_news }}</div>
              <button type="button" class="btn btn-outline-primary" data-open-select="#{{ form.rel_news.id_for_label }}">افزودن</button>
            </div>
            {% for e in form.rel_news.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        {% if form.rel_products %}
          <div class="col-12">
            <label for="{{ form.rel_products.id_for_label }}" class="form-label">{{ form.rel_products.label }}</label>
            <div class="d-flex gap-2">
              <div class="flex-grow-1">{{ form.rel_products }}</div>
              <button type="button" class="btn btn-outline-primary" data-open-select="#{{ form.rel_products.id_for_label }}">افزودن</button>
            </div>
            {% for e in form.rel_products.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
          </div>
        {% endif %}

        <!-- سایر فیلدهای باقی‌مانده -->
        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
        {% for field in form.visible_fields %}
          {% if field.name not in "name,english_name,category_id,brand,price,featured,is_active,owner_name,owner_profile,short_description,description,features,view_image,rel_blogs,rel_news,rel_products" %}
            <div class="col-md-6">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              {{ field }}
              {% for e in field.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
          {% endif %}
        {% endfor %}

        <div class="col-12">
          <button type="submit" class="btn btn-success px-4">
            {% if form.instance.pk %}ذخیره{% else %}ایجاد{% endif %}
          </button>
          <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-outline-secondary ms-2">انصراف</a>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Load jQuery & Select2 locally here so the page actually changes visually -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<style>
  .select2-container .select2-selection--single { height: 38px; }
  .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 36px; }
  .select2-container--default .select2-selection--single .select2-selection__arrow { height: 36px; }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
(function(){
  // --- AJAX-powered Select2 for category and relateds
  function enhanceAjax(sel, url, multiple=false){
    if (!(window.jQuery && jQuery.fn.select2)) return;
    jQuery(sel).select2({
      width: '100%',
      dir: 'rtl',
      multiple: multiple,
      ajax: {
        url: url, dataType: 'json', delay: 250,
        data: function (params) { return { q: params.term }; },
        processResults: function (data) { return { results: data.results || [] }; },
        cache: true
      },
      minimumInputLength: 0
    });
  }

  // Category (single)
  enhanceAjax('#id_category_id', "{% url 'admin_dashboard:api_search_categories' %}", false);

  // Related (multi)
  enhanceAjax('#id_rel_blogs', "{% url 'admin_dashboard:api_search_blogs' %}", true);
  enhanceAjax('#id_rel_news', "{% url 'admin_dashboard:api_search_news' %}", true);
  enhanceAjax('#id_rel_products', "{% url 'admin_dashboard:api_search_products' %}", true);

  // Open dropdown when clicking “افزودن”
  document.querySelectorAll('[data-open-select]').forEach(function(btn){
    btn.addEventListener('click', function(){
      var sel = document.querySelector(btn.getAttribute('data-open-select'));
      if (sel && window.jQuery && jQuery.fn.select2) jQuery(sel).select2('open');
    });
  });

  // Main image preview
  const mainInput = document.getElementById('id_view_image');
  const mainPrev = document.getElementById('main-image-preview');
  if (mainInput && mainPrev){
    mainInput.addEventListener('change', ()=>{
      mainPrev.innerHTML = '';
      const f = mainInput.files?.[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = e=>{
        const img = new Image();
        img.src = e.target.result;
        img.style.height='96px'; img.style.borderRadius='.5rem'; img.style.objectFit='cover'; img.style.border='1px solid #eee';
        mainPrev.appendChild(img);
      };
      r.readAsDataURL(f);
    });
  }

  // Extra images preview
  const multi = document.getElementById('extra-images');
  const grid = document.getElementById('extra-images-preview');
  if (multi && grid){
    multi.addEventListener('change', ()=>{
      grid.innerHTML = '';
      Array.from(multi.files || []).forEach(f=>{
        const r = new FileReader();
        r.onload = e=>{
          const img = new Image();
          img.src = e.target.result;
          img.style.height='72px'; img.style.width='72px'; img.style.objectFit='cover';
          img.style.borderRadius='.5rem'; img.style.border='1px solid #e9ecef';
          grid.appendChild(img);
        };
        r.readAsDataURL(f);
      });
    });
  }

  // Features repeater
  const repeater = document.getElementById('features-repeater');
  const rows = document.getElementById('feature-rows');
  const addBtn = document.getElementById('add-feature');
  const hidden = document.getElementById('features-hidden');

  function addFeatureRow(k='', v=''){
    const row = document.createElement('div');
    row.className = 'row g-2';
    row.innerHTML = `
      <div class="col-md-5"><input type="text" class="form-control feature-key" placeholder="نام ویژگی" value="${k}"></div>
      <div class="col-md-6"><input type="text" class="form-control feature-val" placeholder="مقدار ویژگی" value="${v}"></div>
      <div class="col-md-1 d-grid"><button type="button" class="btn btn-outline-danger remove-feature">&times;</button></div>
    `;
    rows.appendChild(row);
    row.querySelector('.remove-feature').addEventListener('click', ()=> row.remove());
  }

  if (repeater && rows && addBtn && hidden){
    try{
      const initialText = repeater.getAttribute('data-initial') || "{}";
      const initial = JSON.parse(initialText);
      const keys = Object.keys(initial || {});
      if (keys.length){ keys.forEach(k=> addFeatureRow(k, initial[k])); } else { addFeatureRow(); }
    }catch(e){ addFeatureRow(); }

    addBtn.addEventListener('click', ()=> addFeatureRow());

    document.getElementById('product-form').addEventListener('submit', ()=>{
      const obj = {};
      rows.querySelectorAll('.row').forEach(r=>{
        const k = (r.querySelector('.feature-key')?.value || '').trim();
        const v = (r.querySelector('.feature-val')?.value || '').trim();
        if (k) obj[k] = v;
      });
      hidden.value = JSON.stringify(obj);
    });
  }
})();
</script>
{% endblock %}
