{% extends "admin_dashboard/dashboard.html" %}

{% block title %}{{ title|default:"ایجاد محصول" }}{% endblock %}

{% block mainContent %}
<div class="container-fluid px-4">

  <!-- Header -->
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center my-4">
    <h2 class="text-white mb-0">
      {% if form.instance.pk %}ویرایش محصول{% else %}ایجاد محصول{% endif %}
    </h2>
    <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-secondary">بازگشت</a>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
    </div>
  {% endif %}

  {# Flag for JS toast #}
  {% if form.errors %}
    <script>window.__form_has_errors__ = true;</script>
  {% else %}
    <script>window.__form_has_errors__ = false;</script>
  {% endif %}

  {# Always show a top error summary if backend returned any errors #}
  {% if form.errors %}
  <div class="alert alert-danger">
    <strong>بررسی خطاها:</strong>
    <ul class="mb-0">
      {% for field_name, field_errors in form.errors.items %}
        {% if field_name != '__all__' %}
          <li>
            <b>{{ form[field_name].label|default:field_name }}</b>:
            {% for e in field_errors %}{{ e }}{% if not forloop.last %} | {% endif %}{% endfor %}
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form id="product-form" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="row g-4">

      <!-- ===== مشخصات اصلی ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-box-open"></i><span>مشخصات اصلی</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.name %}
              <div class="col-md-6">
                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                {{ form.name }}
                {% for e in form.name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.english_name %}
              <div class="col-md-6">
                <label for="{{ form.english_name.id_for_label }}" class="form-label">{{ form.english_name.label }}</label>
                {{ form.english_name }}
                {% for e in form.english_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {# دسته‌بندی — single, but wired like rel_products with the same Select2 flow #}
              {% if form.category_id %}
              <div class="col-md-6">
                <label for="{{ form.category_id.id_for_label }}" class="form-label">{{ form.category_id.label }}</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">{{ form.category_id }}</div>
                  <button type="button" class="btn btn-outline-primary"
                          data-open-select="#{{ form.category_id.id_for_label }}">افزودن</button>
                  <button type="button" class="btn btn-outline-danger"
                          data-clear-select="#{{ form.category_id.id_for_label }}">حذف</button>
                </div>
                <small class="text-muted d-block mt-1">برای یافتن دسته تایپ کنید… (اختیاری مگر اینکه در بک‌اند اجباری شده باشد)</small>
                {% for e in form.category_id.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.brand %}
              <div class="col-md-6">
                <label for="{{ form.brand.id_for_label }}" class="form-label">{{ form.brand.label }}</label>
                {{ form.brand }}
                {% for e in form.brand.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.price %}
              <div class="col-md-6">
                <label for="{{ form.price.id_for_label }}" class="form-label">{{ form.price.label }}</label>
                {{ form.price }}
                <small class="text-muted d-block mt-1">فقط در نمایش با ویرگول است؛ مقدار خالص ذخیره می‌شود.</small>
                {% for e in form.price.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              <div class="col-md-3 d-flex align-items-end">
                {% if form.featured %}
                <div class="form-check">
                  {{ form.featured }}
                  <label class="form-check-label ms-1" for="{{ form.featured.id_for_label }}">{{ form.featured.label }}</label>
                </div>
                {% endif %}
              </div>

              <div class="col-md-3 d-flex align-items-end">
                {% if form.is_active %}
                <div class="form-check">
                  {{ form.is_active }}
                  <label class="form-check-label ms-1" for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
                </div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ===== مالک و توضیحات ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-user"></i><span>مالک و توضیحات</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.owner_name %}
              <div class="col-md-6">
                <label for="{{ form.owner_name.id_for_label }}" class="form-label">{{ form.owner_name.label }}</label>
                {{ form.owner_name }}
                {% for e in form.owner_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.owner_profile %}
              <div class="col-md-6">
                <label for="{{ form.owner_profile.id_for_label }}" class="form-label">{{ form.owner_profile.label }}</label>
                {{ form.owner_profile }}
                {% for e in form.owner_profile.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.short_description %}
              <div class="col-12">
                <label for="{{ form.short_description.id_for_label }}" class="form-label">{{ form.short_description.label }}</label>
                {{ form.short_description }}
                {% for e in form.short_description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.description %}
              <div class="col-12">
                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% for e in form.description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      <!-- ===== ویژگی‌ها ===== -->
      {% if form.features %}
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-list-ul"></i><span>ویژگی‌ها</span>
          </div>
          <div class="card-body">
            <div id="features-repeater" class="border rounded p-3"
                 data-initial='{{ form.initial.features|default:"{}"|escapejs }}'>
              <div id="feature-rows" class="d-flex flex-column gap-2"></div>
              <button type="button" id="add-feature" class="btn btn-sm btn-outline-primary mt-2">افزودن ویژگی</button>
            </div>
            <textarea id="features-hidden" name="{{ form.features.html_name }}" hidden></textarea>
            {% if form.features.errors %}
              <div class="text-danger small mt-2">
                {% for e in form.features.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ===== تصاویر ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-images"></i><span>تصاویر</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.view_image %}
              <div class="col-md-6">
                <label for="{{ form.view_image.id_for_label }}" class="form-label">{{ form.view_image.label }}</label>
                {% if form.instance.pk and form.instance.view_image %}
                  <div class="mb-2">
                    <img src="{{ form.instance.view_image.url }}" alt="preview"
                         style="max-height:96px;border-radius:.5rem;object-fit:cover;border:1px solid #eee;">
                  </div>
                {% endif %}
                {{ form.view_image }}
                <div id="main-image-preview" class="mt-2"></div>
                {% for e in form.view_image.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              <div class="col-md-6">
                <label class="form-label d-block">تصاویر اضافی</label>
                <div id="extra-images-inputs" class="d-none"></div>
                <div class="d-flex align-items-center gap-2">
                  <button type="button" id="add-extra-image" class="btn btn-outline-primary btn-sm">
                    افزودن تصویر
                  </button>
                  <small class="text-muted">هر کلیک یک تصویر اضافه می‌کند.</small>
                </div>
                <div id="extra-images-preview" class="d-flex flex-wrap gap-2 mt-3"></div>

                {% if form.instance.pk and form.instance.images %}
                  <div class="mt-3">
                    <div class="text-muted mb-1">تصاویر موجود:</div>
                    <div class="d-flex flex-wrap gap-2">
                      {% for img in form.instance.images %}
                        <img src="{{ img }}" alt="image"
                             style="height:72px;width:72px;object-fit:cover;border-radius:.5rem;border:1px solid #e9ecef;">
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ===== ارتباطات ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-link"></i><span>ارتباطات</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.rel_blogs %}
              <div class="col-12">
                <label for="{{ form.rel_blogs.id_for_label }}" class="form-label">{{ form.rel_blogs.label }}</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">{{ form.rel_blogs }}</div>
                  <button type="button" class="btn btn-outline-primary"
                          data-open-select="#{{ form.rel_blogs.id_for_label }}">افزودن</button>
                </div>
                {% for e in form.rel_blogs.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.rel_news %}
              <div class="col-12">
                <label for="{{ form.rel_news.id_for_label }}" class="form-label">{{ form.rel_news.label }}</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">{{ form.rel_news }}</div>
                  <button type="button" class="btn btn-outline-primary"
                          data-open-select="#{{ form.rel_news.id_for_label }}">افزودن</button>
                </div>
                {% for e in form.rel_news.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.rel_products %}
              <div class="col-12">
                <label for="{{ form.rel_products.id_for_label }}" class="form-label">{{ form.rel_products.label }}</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">{{ form.rel_products }}</div>
                  <button type="button" class="btn btn-outline-primary"
                          data-open-select="#{{ form.rel_products.id_for_label }}">افزودن</button>
                </div>
                {% for e in form.rel_products.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      <!-- ===== سایر فیلدها (fallback امن) ===== -->
      {% with excluded="name|english_name|category_id|brand|price|featured|is_active|owner_name|owner_profile|short_description|description|features|view_image|rel_blogs|rel_news|rel_products" %}
        {% for field in form.visible_fields %}
          {% with token="|"|add:field.name|add:"|" all="|"|add:excluded|add:"|" %}
            {% if token not in all %}
              <div class="col-md-6">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% for e in field.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endwith %}
        {% endfor %}
      {% endwith %}

      {% for field in form.hidden_fields %}{{ field }}{% endfor %}

      <!-- ===== Actions ===== -->
      <div class="col-12">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success px-4">
            {% if form.instance.pk %}ذخیره{% else %}ایجاد{% endif %}
          </button>
          <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-outline-secondary">انصراف</a>
        </div>
      </div>

    </div>
  </form>
</div>

<!-- Select2 (RTL) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<style>
  .select2-container .select2-selection--single { height: 38px; }
  .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 36px; }
  .select2-container--default .select2-selection--single .select2-selection__arrow { height: 36px; }
  .toast-error {
    position: fixed; inset-inline-start: 1rem; inset-block-start: 1rem;
    z-index: 1055; background: #f8d7da; color:#842029; border:1px solid #f5c2c7;
    border-radius:.5rem; padding:.75rem 1rem; box-shadow:0 4px 16px rgba(0,0,0,.15);
  }
  .is-invalid { border-color:#dc3545 !important; }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
(function(){
  // ------- Helpers
  function showErrorToast(msg){
    if (!window.__form_has_errors__) return;
    const old = document.querySelector('.toast-error'); if (old) old.remove();
    const div = document.createElement('div');
    div.className = 'toast-error';
    div.textContent = msg || 'فرم کامل نیست. لطفاً فیلدهای قرمز را بررسی کنید.';
    document.body.appendChild(div);
    setTimeout(()=> div.remove(), 4500);
  }

  // Mark invalids if server sent errors
  (function highlightInvalids(){
    if (!window.__form_has_errors__) return;
    const firstErr = document.querySelector('.alert.alert-danger + ul li, .text-danger.small');
    if (firstErr) {
      const targetCard = (firstErr.closest && firstErr.closest('.card')) || document.querySelector('form');
      if (targetCard) targetCard.scrollIntoView({behavior:'smooth', block:'center'});
    }
    document.querySelectorAll('.text-danger.small').forEach(function(err){
      const wrap = err.closest('.card-body') || document;
      const field = wrap.querySelector('input,select,textarea');
      if (field) field.classList.add('is-invalid');
    });
    showErrorToast('فرم کامل نیست. لطفاً خطاهای مشخص‌شده را برطرف کنید.');
  })();

  // Ensure optional multi-selects are not HTML-required (server still decides)
  ['id_rel_blogs','id_rel_news','id_rel_products'].forEach(function(id){
    const el = document.getElementById(id);
    if (el) el.removeAttribute('required');
  });

  // Generic Select2 initializer — category wired EXACTLY like rel_products
  function initAjaxSelect2(selector, url, isMultiple){
    if (!(window.jQuery && jQuery.fn.select2)) return;
    const $el = jQuery(selector);
    if (!$el.length) return;

    if (isMultiple) $el.prop('multiple', true);

    $el.select2({
      width: '100%',
      dir: 'rtl',
      dropdownParent: jQuery('body'),
      multiple: !!isMultiple,
      ajax: {
        url: url,
        dataType: 'json',
        delay: 250,
        data: params => ({ q: params.term }),
        processResults: data => ({ results: (data && data.results) ? data.results : [] }),
        cache: true
      },
      minimumInputLength: 0,
      minimumResultsForSearch: 0,
      placeholder: isMultiple ? 'برای افزودن تایپ کنید…' : 'انتخاب کنید…',
      allowClear: true,
      closeOnSelect: !isMultiple,
      escapeMarkup: m => m
    });

    // Persist selection by injecting <option selected>
    $el.on('select2:select', function (e) {
      const data = e.params && e.params.data;
      if (!data || data.id == null) return;
      let opt = this.querySelector("option[value='" + data.id + "']");
      if (!opt) {
        opt = new Option(data.text, data.id, true, true);
        this.add(opt);
      } else {
        opt.selected = true;
      }
      $el.trigger('change.select2');
    });

    $el.on('select2:unselect', function (e) {
      const data = e.params && e.params.data;
      if (!data) return;
      const opt = this.querySelector("option[value='" + data.id + "']");
      if (opt) opt.selected = false;
    });
  }

  // “افزودن” / “حذف” helpers
  document.querySelectorAll('[data-open-select]').forEach(function(btn){
    btn.addEventListener('click', function(){
      const sel = document.querySelector(btn.getAttribute('data-open-select'));
      if (sel && window.jQuery && jQuery.fn.select2) jQuery(sel).select2('open');
    });
  });
  document.querySelectorAll('[data-clear-select]').forEach(function(btn){
    btn.addEventListener('click', function(){
      const sel = document.querySelector(btn.getAttribute('data-clear-select'));
      if (!sel) return;
      if (window.jQuery && jQuery.fn.select2) jQuery(sel).val(null).trigger('change');
      // Also clear native selection for safety
      [...sel.options].forEach(o => o.selected = false);
    });
  });

  // ====== Initialize Select2s ======
  // دسته‌بندی (single) — same pipeline as rel_products
  initAjaxSelect2('#{{ form.category_id.id_for_label }}',
                  "{% url 'admin_dashboard:api_search_categories' %}", false);

  // Multi relateds
  initAjaxSelect2('#{{ form.rel_blogs.id_for_label }}',
                  "{% url 'admin_dashboard:api_search_blogs' %}", true);
  initAjaxSelect2('#{{ form.rel_news.id_for_label }}',
                  "{% url 'admin_dashboard:api_search_news' %}", true);
  initAjaxSelect2('#{{ form.rel_products.id_for_label }}',
                  "{% url 'admin_dashboard:api_search_products' %}", true);

  // ------- Main image preview
  const mainInput = document.getElementById('{{ form.view_image.id_for_label }}');
  const mainPrev = document.getElementById('main-image-preview');
  if (mainInput && mainPrev){
    mainInput.addEventListener('change', ()=>{
      mainPrev.innerHTML = '';
      const f = mainInput.files?.[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = e=>{
        const img = new Image();
        img.src = e.target.result;
        img.style.height='96px'; img.style.borderRadius='.5rem'; img.style.objectFit='cover'; img.style.border='1px solid #eee';
        mainPrev.appendChild(img);
      };
      r.readAsDataURL(f);
    });
  }

  // ------- Features repeater
  const repeater = document.getElementById('features-repeater');
  const rows = document.getElementById('feature-rows');
  const addBtn = document.getElementById('add-feature');
  const hidden = document.getElementById('features-hidden');

  function addFeatureRow(k='', v=''){
    const row = document.createElement('div');
    row.className = 'row g-2';
    row.innerHTML = `
      <div class="col-md-5"><input type="text" class="form-control feature-key" placeholder="نام ویژگی" value="${k}"></div>
      <div class="col-md-6"><input type="text" class="form-control feature-val" placeholder="مقدار ویژگی" value="${v}"></div>
      <div class="col-md-1 d-grid"><button type="button" class="btn btn-outline-danger remove-feature">&times;</button></div>
    `;
    rows.appendChild(row);
    row.querySelector('.remove-feature').addEventListener('click', ()=> row.remove());
  }

  if (repeater && rows && addBtn && hidden){
    try{
      const initialText = repeater.getAttribute('data-initial') || "{}";
      const initial = JSON.parse(initialText);
      const keys = Object.keys(initial || {});
      if (keys.length){ keys.forEach(k=> addFeatureRow(k, initial[k])); } else { addFeatureRow(); }
      // initialize hidden so backend never gets empty value if required
      hidden.value = JSON.stringify(initial || {});
    }catch(e){
      addFeatureRow();
      hidden.value = "{}";
    }

    addBtn.addEventListener('click', ()=> addFeatureRow());
  }

  // ------- Incremental extra images
  const inputsWrap = document.getElementById('extra-images-inputs');
  const addImgBtn  = document.getElementById('add-extra-image');
  const grid       = document.getElementById('extra-images-preview');
  let counter = 0;

  if (inputsWrap && addImgBtn && grid) {
    addImgBtn.addEventListener('click', () => {
      const input = document.createElement('input');
      input.type = 'file';
      input.name = 'extra_images';
      input.accept = 'image/*';
      input.className = 'd-none';
      input.dataset.key = `img-${++counter}`;

      inputsWrap.appendChild(input);

      input.addEventListener('change', () => {
        if (!input.files || !input.files[0]) { input.remove(); return; }

        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          const wrap = document.createElement('div');
          wrap.className = 'position-relative';
          wrap.dataset.key = input.dataset.key;

          const img = new Image();
          img.src = e.target.result;
          img.style.height='72px'; img.style.width='72px'; img.style.objectFit='cover';
          img.style.borderRadius='.5rem'; img.style.border='1px solid #e9ecef';

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'btn btn-sm btn-danger position-absolute';
          removeBtn.style.top='-8px'; removeBtn.style.left='-8px';
          removeBtn.style.borderRadius='50%'; removeBtn.style.lineHeight='1'; removeBtn.style.padding='2px 6px';
          removeBtn.innerHTML = '&times;';

          removeBtn.addEventListener('click', () => { wrap.remove(); input.remove(); });

          wrap.appendChild(img);
          wrap.appendChild(removeBtn);
          grid.appendChild(wrap);
        };
        reader.readAsDataURL(file);
      });

      input.click();
    });
  }

  // ------- Submit: serialize features + strip price commas
  const form = document.getElementById('product-form');
  const priceInput = document.getElementById('{{ form.price.id_for_label }}');

  // live comma format for price
  if (priceInput) {
    const format = (s) => (s || '').replace(/[^\d]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    if (priceInput.value && !/,/.test(priceInput.value)) { priceInput.value = format(priceInput.value); }
    priceInput.addEventListener('input', function () {
      const el = this;
      const oldPos = el.selectionStart || 0;
      const digitsBefore = (el.value.slice(0, oldPos).match(/\d/g) || []).length;
      el.value = format(el.value);
      let idx = 0, pos = 0;
      for (; pos < el.value.length; pos++) { if (/\d/.test(el.value[pos])) idx++; if (idx >= digitsBefore) { pos++; break; } }
      el.setSelectionRange(pos, pos);
    });
  }

  if (form) {
    form.addEventListener('submit', function () {
      // features -> hidden JSON (ensure {} even if empty)
      if (rows && hidden) {
        const obj = {};
        rows.querySelectorAll('.row').forEach(r=>{
          const k = (r.querySelector('.feature-key')?.value || '').trim();
          const v = (r.querySelector('.feature-val')?.value || '').trim();
          if (k) obj[k] = v;
        });
        hidden.value = JSON.stringify(obj);
        if (!hidden.value) hidden.value = "{}";
      }
      // strip price commas
      if (priceInput) priceInput.value = priceInput.value.replace(/,/g, '');
    });
  }
})();
</script>
{% endblock %}
