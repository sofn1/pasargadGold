{% extends "admin_dashboard/dashboard.html" %}

{% block title %}{{ title|default:"ایجاد محصول" }}{% endblock %}

{% block mainContent %}
<div class="container-fluid px-4">

  <!-- Header -->
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center my-4">
    <h2 class="text-white mb-0">
      {% if form.instance.pk %}ویرایش محصول{% else %}ایجاد محصول{% endif %}
    </h2>
    <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-secondary">بازگشت</a>
  </div>

  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
    </div>
  {% endif %}

  {% if form.errors %}
    <script>window.__form_has_errors__ = true;</script>
    <div class="alert alert-danger">
      <strong>بررسی خطاها:</strong>
      <ul class="mb-0">
        {% for bf in form %}
          {% if bf.errors %}
            <li><b>{{ bf.label }}</b>:
              {% for e in bf.errors %}{{ e }}{% if not forloop.last %} | {% endif %}{% endfor %}
            </li>
          {% endif %}
        {% endfor %}
        {% for hf in form.hidden_fields %}
          {% if hf.errors %}
            <li><b>{{ hf.name }}</b>:
              {% for e in hf.errors %}{{ e }}{% if not forloop.last %} | {% endif %}{% endfor %}
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    </div>
  {% else %}
    <script>window.__form_has_errors__ = false;</script>
  {% endif %}

  <form id="product-form" method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    <div class="row g-4">

      <!-- ===== مشخصات اصلی ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-box-open"></i><span>مشخصات اصلی</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.name %}
              <div class="col-md-6">
                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                {{ form.name }}
                {% for e in form.name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.english_name %}
              <div class="col-md-6">
                <label for="{{ form.english_name.id_for_label }}" class="form-label">{{ form.english_name.label }}</label>
                {{ form.english_name }}
                {% for e in form.english_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {# دسته‌بندی — single, wired exactly like محصولات مرتبط (Select2 + sticky + open/clear) #}
              {% if form.category_id %}
                <div class="col-md-6">
                  <label for="{{ form.category_id.id_for_label }}" class="form-label">{{ form.category_id.label }}</label>

                  {# we keep the original select, but also mark a stable selector via data-select-target #}
                  <div class="d-flex gap-2 align-items-start" 
                      data-select-target="[name='{{ form.category_id.html_name|default:"category" }}']">
                    <div class="flex-grow-1">{{ form.category_id }}</div>
                    <div class="d-flex flex-column gap-2">
                      <button type="button" class="btn btn-outline-primary"
                              data-open-select>افزودن</button>
                      <button type="button" class="btn btn-outline-danger"
                              data-clear-select>حذف</button>
                    </div>
                  </div>

                  <small class="text-muted d-block mt-1">برای یافتن دسته تایپ کنید…</small>
                  {% for e in form.category_id.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                </div>
              {% endif %}


              {% if form.brand %}
              <div class="col-md-6">
                <label for="{{ form.brand.id_for_label }}" class="form-label">{{ form.brand.label }}</label>
                {{ form.brand }}
                {% for e in form.brand.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.price %}
              <div class="col-md-6">
                <label for="{{ form.price.id_for_label }}" class="form-label">{{ form.price.label }}</label>
                {{ form.price }}
                <small class="text-muted d-block mt-1">نمایش با ویرگول؛ مقدار خالص ذخیره می‌شود.</small>
                {% for e in form.price.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              <div class="col-md-3 d-flex align-items-end">
                {% if form.featured %}
                <div class="form-check">
                  {{ form.featured }}
                  <label class="form-check-label ms-1" for="{{ form.featured.id_for_label }}">{{ form.featured.label }}</label>
                </div>
                {% endif %}
              </div>

              <div class="col-md-3 d-flex align-items-end">
                {% if form.is_active %}
                <div class="form-check">
                  {{ form.is_active }}
                  <label class="form-check-label ms-1" for="{{ form.is_active.id_for_label }}">{{ form.is_active.label }}</label>
                </div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ===== مالک و توضیحات ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-user"></i><span>مالک و توضیحات</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.owner_name %}
              <div class="col-md-6">
                <label for="{{ form.owner_name.id_for_label }}" class="form-label">{{ form.owner_name.label }}</label>
                {{ form.owner_name }}
                {% for e in form.owner_name.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.owner_profile %}
              <div class="col-md-6">
                <label for="{{ form.owner_profile.id_for_label }}" class="form-label">{{ form.owner_profile.label }}</label>
                {{ form.owner_profile }}
                {% for e in form.owner_profile.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.short_description %}
              <div class="col-12">
                <label for="{{ form.short_description.id_for_label }}" class="form-label">{{ form.short_description.label }}</label>
                {{ form.short_description }}
                {% for e in form.short_description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.description %}
              <div class="col-12">
                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
                {% for e in form.description.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      <!-- ===== ویژگی‌ها (JSON) ===== -->
      {% if form.features %}
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-list-ul"></i><span>{{ form.features.label|default:"ویژگی‌ها (JSON)" }}</span>
          </div>
          <div class="card-body">
            <div id="features-repeater" class="border rounded p-3"
                 data-initial='{{ form.initial.features|default:"{}"|escapejs }}'>
              <div id="feature-rows" class="d-flex flex-column gap-2"></div>
              <button type="button" id="add-feature" class="btn btn-sm btn-outline-primary mt-2">
                افزودن ویژگی
              </button>
            </div>
            <textarea id="features-hidden" name="{{ form.features.html_name }}" hidden></textarea>
            {% if form.features.errors %}
              <div class="text-danger small mt-2">
                {% for e in form.features.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- ===== تصاویر ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-images"></i><span>تصاویر</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {# تصویر اصلی (اگر دارید) #}
              {% if form.view_image %}
              <div class="col-md-6">
                <label for="{{ form.view_image.id_for_label }}" class="form-label">{{ form.view_image.label }}</label>
                {% if form.instance.pk and form.instance.view_image %}
                  <div class="mb-2">
                    <img src="{{ form.instance.view_image.url }}" alt="preview"
                         style="max-height:96px;border-radius:.5rem;object-fit:cover;border:1px solid #eee;">
                  </div>
                {% endif %}
                {{ form.view_image }}
                <div id="main-image-preview" class="mt-2"></div>
                {% for e in form.view_image.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {# گالری تصاویر — render real widget OR inject fallback #}
              <div class="col-md-6">
                <label class="form-label d-block">
                  {% if form.images %}{{ form.images.label|default:"تصاویر اضافی" }}{% else %}تصاویر اضافی{% endif %}
                </label>

                <div id="images-field-wrap">
                  {% if form.images %}
                    {{ form.images }}
                  {% endif %}
                </div>

                <div class="d-flex align-items-center gap-2 mt-2">
                  <button type="button" id="add-extra-image" class="btn btn-outline-primary btn-sm">
                    افزودن تصویر
                  </button>
                  <small class="text-muted">می‌توانید چند تصویر را با هم انتخاب کنید.</small>
                </div>

                <div id="extra-images-preview" class="d-flex flex-wrap gap-2 mt-3"></div>

                {% if form.images %}
                  {% if form.images.errors %}
                    <div class="text-danger small mt-2">
                      {% for e in form.images.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                    </div>
                  {% endif %}
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- ===== ارتباطات ===== -->
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-dark text-white d-flex align-items-center gap-2">
            <i class="fas fa-link"></i><span>ارتباطات</span>
          </div>
          <div class="card-body">
            <div class="row g-4">

              {% if form.rel_blogs %}
              <div class="col-12">
                <label for="{{ form.rel_blogs.id_for_label }}" class="form-label">{{ form.rel_blogs.label }}</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">{{ form.rel_blogs }}</div>
                  <button type="button" class="btn btn-outline-primary"
                          data-open-select="#{{ form.rel_blogs.id_for_label }}">افزودن</button>
                </div>
                {% for e in form.rel_blogs.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.rel_news %}
              <div class="col-12">
                <label for="{{ form.rel_news.id_for_label }}" class="form-label">{{ form.rel_news.label }}</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">{{ form.rel_news }}</div>
                  <button type="button" class="btn btn-outline-primary"
                          data-open-select="#{{ form.rel_news.id_for_label }}">افزودن</button>
                </div>
                {% for e in form.rel_news.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

              {% if form.rel_products %}
              <div class="col-12">
                <label for="{{ form.rel_products.id_for_label }}" class="form-label">{{ form.rel_products.label }}</label>
                <div class="d-flex gap-2">
                  <div class="flex-grow-1">{{ form.rel_products }}</div>
                  <button type="button" class="btn btn-outline-primary"
                          data-open-select="#{{ form.rel_products.id_for_label }}">افزودن</button>
                </div>
                {% for e in form.rel_products.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              </div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>

      <!-- ===== سایر فیلدها (fallback امن) ===== -->
      {% with excluded="name|english_name|category_id|brand|price|featured|is_active|owner_name|owner_profile|short_description|description|features|view_image|images|rel_blogs|rel_news|rel_products" %}
        {% for field in form.visible_fields %}
          {% with token="|"|add:field.name|add:"|" all="|"|add:excluded|add:"|" %}
            {% if token not in all %}
              <div class="col-md-6">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% for e in field.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endwith %}
        {% endfor %}
      {% endwith %}

      {% for field in form.hidden_fields %}{{ field }}{% endfor %}

      <!-- ===== Actions ===== -->
      <div class="col-12">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success px-4">
            {% if form.instance.pk %}ذخیره{% else %}ایجاد{% endif %}
          </button>
          <a href="{% url 'admin_dashboard:admin_products' %}" class="btn btn-outline-secondary">انصراف</a>
        </div>
      </div>

    </div>
  </form>
</div>

<!-- Select2 (RTL) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<style>
  .select2-container .select2-selection--single { height: 38px; }
  .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 36px; }
  .select2-container--default .select2-selection--single .select2-selection__arrow { height: 36px; }
  .is-invalid { border-color:#dc3545 !important; }
  .thumb { height:72px;width:72px;object-fit:cover;border-radius:.5rem;border:1px solid #e9ecef; }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
(function(){
  // ---------- Error highlighting
  (function highlightInvalids(){
    if (!window.__form_has_errors__) return;
    document.querySelectorAll('.text-danger.small').forEach(function(err){
      const wrap = err.closest('.card-body') || document;
      const field = wrap.querySelector('input,select,textarea');
      if (field) field.classList.add('is-invalid');
    });
  })();

  // ---------- Select2 init (category wired like related products)
  function initAjaxSelect2(selector, url, isMultiple){
    if (!(window.jQuery && jQuery.fn.select2)) return;
    const $el = jQuery(selector);
    if (!$el.length) return;

    if (!isMultiple && !$el.find('option[value=""]').length) {
      $el.prepend(new Option('', '', false, false));
    }
    if (isMultiple) $el.prop('multiple', true);

    $el.select2({
      width: '100%',
      dir: 'rtl',
      dropdownParent: jQuery('body'),
      multiple: !!isMultiple,
      ajax: {
        url: url, dataType: 'json', delay: 250,
        data: params => ({ q: params.term }),
        processResults: data => ({ results: (data && data.results) ? data.results : [] }),
        cache: true
      },
      minimumInputLength: 0,
      minimumResultsForSearch: 0,
      placeholder: isMultiple ? 'برای افزودن تایپ کنید…' : 'انتخاب کنید…',
      allowClear: true,
      closeOnSelect: !isMultiple,
      escapeMarkup: m => m
    });

    $el.on('select2:select', function (e) {
      const data = e.params && e.params.data;
      if (!data || data.id == null) return;
      let opt = this.querySelector("option[value='" + data.id + "']");
      if (!opt) { opt = new Option(data.text, data.id, true, true); this.add(opt); }
      else { opt.selected = true; }
      $el.trigger('change.select2');
    });

    $el.on('select2:unselect', function (e) {
      const data = e.params && e.params.data;
      if (!data) return;
      const opt = this.querySelector("option[value='" + data.id + "']");
      if (opt) opt.selected = false;
    });
  }

  // Delegated open/clear for select2s — Single listener, correct behavior
  // open the select2 dropdown
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-open-select]');
    if (!btn || !(window.jQuery && jQuery.fn.select2)) return;
    const wrap = btn.closest('[data-select-target]');
    const selector = wrap ? wrap.getAttribute('data-select-target') : null;
    const sel = selector ? document.querySelector(selector) : null;
    if (sel) jQuery(sel).select2('open');
  });

  // clear selection
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-clear-select]');
    if (!btn) return;
    const wrap = btn.closest('[data-select-target]');
    const selector = wrap ? wrap.getAttribute('data-select-target') : null;
    const sel = selector ? document.querySelector(selector) : null;
    if (!sel) return;
    if (window.jQuery && jQuery.fn.select2) jQuery(sel).val(null).trigger('change');
    Array.from(sel.options || []).forEach(o => o.selected = false);
  });


  // Initialize Select2s
  initAjaxSelect2("[name='{{ form.category_id.html_name|default:"category" }}']", "{% url 'admin_dashboard:api_search_categories' %}", false);
  initAjaxSelect2('#{{ form.rel_blogs.id_for_label }}', "{% url 'admin_dashboard:api_search_blogs' %}", true);
  initAjaxSelect2('#{{ form.rel_news.id_for_label }}', "{% url 'admin_dashboard:api_search_news' %}", true);
  initAjaxSelect2('#{{ form.rel_products.id_for_label }}', "{% url 'admin_dashboard:api_search_products' %}", true);

  // ---------- Features repeater
  const repeater = document.getElementById('features-repeater');
  const rows = document.getElementById('feature-rows');
  const addBtn = document.getElementById('add-feature');
  const hidden = document.getElementById('features-hidden');

  function addFeatureRow(k='', v=''){
    const row = document.createElement('div');
    row.className = 'row g-2';
    row.innerHTML = `
      <div class="col-md-5"><input type="text" class="form-control feature-key" placeholder="نام ویژگی" value="${k}"></div>
      <div class="col-md-6"><input type="text" class="form-control feature-val" placeholder="مقدار ویژگی" value="${v}"></div>
      <div class="col-md-1 d-grid"><button type="button" class="btn btn-outline-danger remove-feature">&times;</button></div>
    `;
    rows.appendChild(row);
    row.querySelector('.remove-feature').addEventListener('click', ()=> row.remove());
  }

  if (repeater && rows && addBtn && hidden){
    let initialObj = {};
    try{
      const initialText = repeater.getAttribute('data-initial') || "{}";
      initialObj = JSON.parse(initialText || "{}") || {};
    }catch(e){ initialObj = {}; }
    const keys = Object.keys(initialObj);
    if (keys.length){ keys.forEach(k=> addFeatureRow(k, initialObj[k])); } else { addFeatureRow(); }
    hidden.value = JSON.stringify(initialObj); // ensure not empty

    addBtn.addEventListener('click', ()=> addFeatureRow());
  }

  function featuresToHidden(){
    if (!(rows && hidden)) return;
    const obj = {};
    rows.querySelectorAll('.row').forEach(r=>{
      const k = (r.querySelector('.feature-key')?.value || '').trim();
      const v = (r.querySelector('.feature-val')?.value || '').trim();
      if (k) obj[k] = v;
    });
    const json = JSON.stringify(obj);
    hidden.value = json && json.length ? json : '{}';
  }

  // ---------- Images: ensure input exists, multiple, previews, and button opens it
  const imagesWrap = document.getElementById('images-field-wrap');
  const previews = document.getElementById('extra-images-preview');
  const openBtn = document.getElementById('add-extra-image');

  // Values (fall back if form.images is missing)
  const imagesName = '{{ form.images.html_name|default:"images" }}';
  const imagesId   = '{{ form.images.id_for_label|default:"id_images" }}';

  function ensureImagesInput(){
    if (!imagesWrap) return null;
    let input = imagesWrap.querySelector('input[type="file"][name="'+imagesName+'"]');
    if (!input) {
      input = document.createElement('input');
      input.type = 'file';
      input.name = imagesName;
      input.id = imagesId;
      input.accept = 'image/*';
      input.multiple = true;
      input.className = 'form-control';
      imagesWrap.appendChild(input);
    } else {
      // enforce attributes
      input.accept = 'image/*';
      input.multiple = true;
      if (!input.id) input.id = imagesId || ('id_' + imagesName);
      if (!input.classList.contains('form-control')) input.classList.add('form-control');
    }
    return input;
  }

  function renderPreviews(fileList){
    if (!previews) return;
    previews.innerHTML = '';
    Array.from(fileList || []).forEach(file=>{
      if (!file.type || !file.type.startsWith('image/')) return;
      const r = new FileReader();
      r.onload = e=>{
        const wrap = document.createElement('div');
        wrap.className = 'position-relative';
        const img = new Image();
        img.src = e.target.result;
        img.className = 'thumb';
        wrap.appendChild(img);
        previews.appendChild(wrap);
      };
      r.readAsDataURL(file);
    });
  }

  const imagesInput = ensureImagesInput();

  if (imagesInput){
    imagesInput.addEventListener('change', ()=> renderPreviews(imagesInput.files));
  }
  if (openBtn){
    openBtn.addEventListener('click', ()=> {
      const input = ensureImagesInput();
      if (input) input.click();
    });
  }

  // ---------- Price formatting + submit handlers
  const formEl = document.getElementById('product-form');
  const priceInput = document.getElementById('{{ form.price.id_for_label }}');

  if (priceInput) {
    const format = (s) => (s || '').replace(/[^\d]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    if (priceInput.value && !/,/.test(priceInput.value)) { priceInput.value = format(priceInput.value); }
    priceInput.addEventListener('input', function () {
      const el = this;
      const oldPos = el.selectionStart || 0;
      const digitsBefore = (el.value.slice(0, oldPos).match(/\d/g) || []).length;
      el.value = format(el.value);
      let idx = 0, pos = 0;
      for (; pos < el.value.length; pos++) { if (/\d/.test(el.value[pos])) idx++; if (idx >= digitsBefore) { pos++; break; } }
      el.setSelectionRange(pos, pos);
    });
  }

  if (formEl) {
    formEl.addEventListener('submit', function () {
      featuresToHidden();
      if (priceInput) priceInput.value = priceInput.value.replace(/,/g, '');
    });
  }
})();
</script>
{% endblock %}
