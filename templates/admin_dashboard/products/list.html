{% extends "admin_dashboard/dashboard.html" %}

{% block title %}مدیریت محصولات{% endblock %}

{% block mainContent %}
<div class="container-fluid px-4">

  <!-- Header -->
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center gap-2">
      <h2 class="text-white mb-0">محصولات</h2>
      {% if products %}
      <span class="badge bg-secondary">{{ page_obj.paginator.count }} مورد</span>
      {% endif %}
    </div>
    <a href="{% url 'admin_dashboard:admin_product_create' %}" class="btn btn-success">
      <i class="fas fa-plus"></i> افزودن محصول جدید
    </a>
  </div>

  <!-- Search (GET; works with pagination) -->
  <form method="get" class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
          <label for="id_field" class="form-label mb-1">فیلد</label>
          <select class="form-select" id="id_field" name="field">
            {% with f=request.GET.field|default_if_none:'' %}
            <option value="" {% if not f %}selected{% endif %}>همه (نام/نام انگلیسی)</option>
            <option value="name" {% if f == 'name' %}selected{% endif %}>نام</option>
            <option value="english_name" {% if f == 'english_name' %}selected{% endif %}>نام انگلیسی</option>
            <option value="category" {% if f == 'category' %}selected{% endif %}>دسته</option>
            <option value="brand" {% if f == 'brand' %}selected{% endif %}>برند</option>
            <option value="price" {% if f == 'price' %}selected{% endif %}>قیمت</option>
            <option value="features" {% if f == 'features' %}selected{% endif %}>ویژگی‌ها</option>
            <option value="status" {% if f == 'status' %}selected{% endif %}>وضعیت</option>
            {% endwith %}
          </select>
        </div>

        <div class="col-12 col-md-7" id="text-search-wrap">
          <label for="id_q" class="form-label mb-1">جستجو</label>
          <input type="text"
                 class="form-control"
                 id="id_q"
                 name="q"
                 value="{{ request.GET.q|default_if_none:'' }}"
                 placeholder="عبارت را وارد کنید… (برای قیمت: 1000000 یا 500000-2000000)">
        </div>

        <div class="col-12 col-md-7 d-none" id="status-search-wrap">
          <label for="id_status" class="form-label mb-1">وضعیت</label>
          <select class="form-select" id="id_status" name="status">
            {% with s=request.GET.status|default_if_none:'' %}
            <option value="" {% if not s %}selected{% endif %}>همه</option>
            <option value="active" {% if s == 'active' %}selected{% endif %}>فعال</option>
            <option value="inactive" {% if s == 'inactive' %}selected{% endif %}>غیرفعال</option>
            {% endwith %}
          </select>
        </div>

        <div class="col-12 col-md-2 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">
            <i class="fas fa-search"></i> جستجو
          </button>
          <a class="btn btn-outline-secondary" href="{% url 'admin_dashboard:admin_products' %}">پاک‌سازی</a>
        </div>
      </div>
    </div>
  </form>

  {% if products %}

  <!-- Mobile / Tablet: Card layout -->
  <div class="d-lg-none">
    <div class="row g-3">
      {% for product in products %}
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex gap-3">
              <div>
                {% if product.view_image %}
                  <img src="{{ product.view_image.url }}" alt="{{ product.name }}"
                       style="height:72px;width:72px;object-fit:cover;border-radius:.75rem;border:1px solid #e9ecef;">
                {% elif product.image %}
                  <img src="{{ product.image.url }}" alt="{{ product.name }}"
                       style="height:72px;width:72px;object-fit:cover;border-radius:.75rem;border:1px solid #e9ecef;">
                {% elif product.images and product.images.0 %}
                  <img src="{{ product.images.0 }}" alt="{{ product.name }}"
                       style="height:72px;width:72px;object-fit:cover;border-radius:.75rem;border:1px solid #e9ecef;">
                {% else %}
                  <div class="d-flex align-items-center justify-content-center bg-light"
                       style="height:72px;width:72px;border-radius:.75rem;border:1px solid #e9ecef;">
                    <i class="fas fa-image text-muted"></i>
                  </div>
                {% endif %}
              </div>

              <div class="flex-grow-1">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <div class="fw-semibold">{{ product.name|default:"—" }}</div>
                  {% if product.is_active %}
                    <span class="badge bg-success">فعال</span>
                  {% else %}
                    <span class="badge bg-danger">غیرفعال</span>
                  {% endif %}
                  {% if product.featured %}
                    <span class="badge bg-warning text-dark">ویژه</span>
                  {% endif %}
                </div>

                {% if product.english_name %}
                  <div class="text-muted small mt-1">{{ product.english_name }}</div>
                {% endif %}

                {% if product.short_description %}
                  <div class="text-muted small mt-1">{{ product.short_description|truncatechars:120 }}</div>
                {% endif %}

                <div class="mt-2 d-flex flex-wrap gap-2">
                  <span class="badge bg-dark-subtle text-dark border" title="برند">
                    <i class="fas fa-tag me-1"></i>
                    {% if product.brand %}{{ product.brand.name|default:product.brand }}{% else %}—{% endif %}
                  </span>

                  {% with cats=product.categories.all %}
                    {% if cats %}
                      {% for c in cats|slice:":3" %}
                        <span class="badge bg-light text-dark border" title="دسته">
                          <i class="fas fa-folder me-1"></i>{{ c.name|default:c.english_name|default:c.slug }}
                        </span>
                      {% endfor %}
                      {% if cats|length > 3 %}
                        <span class="badge bg-secondary">+{{ cats|length|add:"-3" }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-light text-muted border">بدون دسته</span>
                    {% endif %}
                  {% endwith %}
                </div>

                <div class="mt-2">
                  <span class="fw-semibold price-m" data-price="{{ product.price|default_if_none:'' }}">
                    {% if product.price %}{{ product.price }}{% else %}—{% endif %}
                  </span>
                </div>

                <div class="text-muted small mt-1">
                  <i class="far fa-clock"></i>
                  {{ product.created_at|date:"Y/m/d H:i" }}
                </div>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <a href="{% url 'admin_dashboard:admin_product_edit' product.pk %}" class="btn btn-sm btn-warning">
                <i class="fas fa-edit"></i> ویرایش
              </a>
              <button type="button"
                      class="btn btn-sm btn-danger"
                      data-bs-toggle="modal"
                      data-bs-target="#deleteModal"
                      data-id="{{ product.pk }}"
                      data-name="{{ product.name }}">
                <i class="fas fa-trash"></i> حذف
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% include 'admin_dashboard/_pagination.html' %}
  </div>

  <!-- Desktop: Table layout -->
  <div class="card shadow-sm d-none d-lg-block">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
          <tr>
            <th style="width:80px;">تصویر</th>
            <th>نام</th>
            <th>برند</th>
            <th style="min-width:220px;">دسته‌ها</th>
            <th style="width:140px;">قیمت</th>
            <th style="width:120px;">وضعیت</th>
            <th style="width:160px;">ایجاد</th>
            <th style="width:160px;">عملیات</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
          <tr>
            <td>
              {% if product.view_image %}
                <img src="{{ product.view_image.url }}" alt="{{ product.name }}"
                     style="height:56px;width:56px;object-fit:cover;border-radius:.5rem;border:1px solid #e9ecef;">
              {% elif product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}"
                     style="height:56px;width:56px;object-fit:cover;border-radius:.5rem;border:1px solid #e9ecef;">
              {% elif product.images and product.images.0 %}
                <img src="{{ product.images.0 }}" alt="{{ product.name }}"
                     style="height:56px;width:56px;object-fit:cover;border-radius:.5rem;border:1px solid #e9ecef;">
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              <div class="fw-semibold d-flex align-items-center gap-2">
                {{ product.name|default:"—" }}
                {% if product.featured %}
                  <span class="badge bg-warning text-dark">ویژه</span>
                {% endif %}
              </div>
              {% if product.english_name %}
                <div class="text-muted small">{{ product.english_name }}</div>
              {% endif %}
              {% if product.short_description %}
                <div class="text-muted small">{{ product.short_description|truncatechars:120 }}</div>
              {% endif %}
            </td>

            <td>
              {% if product.brand %}
                {{ product.brand.name|default:product.brand }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td>
              <div class="d-flex flex-wrap gap-1">
                {% with cats=product.categories.all %}
                  {% if cats %}
                    {% for c in cats|slice:":4" %}
                      <span class="badge bg-light text-dark border">{{ c.name|default:c.english_name|default:c.slug }}</span>
                    {% endfor %}
                    {% if cats|length > 4 %}
                      <span class="badge bg-secondary">+{{ cats|length|add:"-4" }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                {% endwith %}
              </div>
            </td>

            <td class="fw-semibold">
              <span class="price-m" data-price="{{ product.price|default_if_none:'' }}">
                {% if product.price %}{{ product.price }}{% else %}—{% endif %}
              </span>
            </td>

            <td>
              {% if product.is_active %}
                <span class="badge bg-success">فعال</span>
              {% else %}
                <span class="badge bg-danger">غیرفعال</span>
              {% endif %}
            </td>

            <td class="text-muted small">
              {{ product.created_at|date:"Y/m/d H:i" }}
            </td>

            <td>
              <div class="btn-group">
                <a href="{% url 'admin_dashboard:admin_product_edit' product.pk %}" class="btn btn-sm btn-warning">
                  <i class="fas fa-edit"></i> ویرایش
                </a>
                <button type="button"
                        class="btn btn-sm btn-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal"
                        data-id="{{ product.pk }}"
                        data-name="{{ product.name }}">
                  <i class="fas fa-trash"></i> حذف
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% include 'admin_dashboard/_pagination.html' %}

  {% else %}
    <div class="alert alert-info">محصولی یافت نشد.</div>
  {% endif %}

  {% include 'admin_dashboard/_delete_modal.html' with object_type="محصول" delete_url_name='admin_dashboard:admin_product_delete' delete_dummy_pk=0 return_url='admin_dashboard:admin_products' %}

</div>

<!-- JS: price formatting (no humanize needed) + delete modal wiring -->
<script>
  (function(){
    const fieldEl = document.getElementById('id_field');
    const textWrap = document.getElementById('text-search-wrap');
    const statusWrap = document.getElementById('status-search-wrap');
    const qEl = document.getElementById('id_q');

    function syncUI(){
      const v = fieldEl.value || '';
      const statusMode = (v === 'status');
      statusWrap.classList.toggle('d-none', !statusMode);
      textWrap.classList.toggle('d-none', statusMode);

      if (v === 'price') {
        qEl.placeholder = 'مثال: 1000000 یا 500000-2000000 یا >1000000 یا <2000000';
      } else if (v === 'category') {
        qEl.placeholder = 'نام دسته / اسلاگ…';
      } else if (v === 'brand') {
        qEl.placeholder = 'نام برند…';
      } else if (v === 'features') {
        qEl.placeholder = 'نام یا مقدار ویژگی (مانند: Color یا Gold)…';
      } else {
        qEl.placeholder = 'عبارت را وارد کنید…';
      }
    }
    if (fieldEl) {
      fieldEl.addEventListener('change', syncUI);
      syncUI(); // on load
    }

    // Price formatter:
    // - >= 1,000,000 → "X M" or "X/YYY M" (e.g., 1,000,000 -> 1M; 1,235,000 -> 1/235 M)
    // - < 1,000,000 → standard thousands separators
    function formatCompact(n) {
      if (n === null || n === undefined || n === '') return null;
      const num = Number(String(n).replace(/[^\d.-]/g, ''));
      if (isNaN(num)) return null;

      // Billions
      if (num >= 1_000_000_000) {
        const whole = Math.floor(num / 1_000_000_000);                 // billions
        const remainderM = Math.floor((num % 1_000_000_000) / 1_000_000); // next 3 digits (millions)
        if (remainderM <= 0) return `${whole}B`;
        const pad = String(remainderM).padStart(3, '0');
        return `${whole}/${pad} B`;
      }

      // Millions
      if (num >= 1_000_000) {
        const whole = Math.floor(num / 1_000_000);               // millions
        const remainderK = Math.floor((num % 1_000_000) / 1000); // thousands remainder
        if (remainderK <= 0) return `${whole}M`;
        const pad = String(remainderK).padStart(3, '0');
        return `${whole}/${pad} M`;
      }

      // Thousands
      if (num >= 1_000) {
        const whole = Math.floor(num / 1000);             // thousands
        const remainder = num % 1000;                     // remainder in units
        if (remainder <= 0) return `${whole}K`;
        const pad = String(remainder).padStart(3, '0');
        return `${whole}/${pad} K`;
      }

      // < 1000 → show plain number
      return num.toString();
    }


    // Apply formatter to all price cells
    document.querySelectorAll('.price-m').forEach(function(el){
      const raw = el.getAttribute('data-price');
      const fmt = formatCompact(raw);
      if (fmt !== null) el.textContent = fmt;
    });

    // Delete modal wiring (if your partial expects dynamic action)
    const modal = document.getElementById('deleteModal');
    if (!modal) return;
    modal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const id = button?.getAttribute('data-id');
      const name = button?.getAttribute('data-name') || '—';

      // Put product name into a placeholder inside modal (if exists)
      const nameHolder = modal.querySelector('[data-delete-name]');
      if (nameHolder) nameHolder.textContent = name;

      // Set form action from a template if your partial provides it
      const form = modal.querySelector('form');
      if (form && id) {
        const base = form.getAttribute('data-action-base'); // e.g., "/admin-dashboard/products/__ID__/delete/"
        if (base) {
          form.action = base.replace('__ID__', id);
        } else {
          const tmpl = modal.getAttribute('data-delete-url-template');
          if (tmpl) form.action = tmpl.replace('__ID__', id);
        }
      }
    });
  })();
</script>
{% endblock %}
